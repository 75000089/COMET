---
title: "Figures imputation"
author: "Lucy Grigoroff"
date: "2023-09-14"
output: html_document
---


```{r cars}



library(ggplot2)
library(ggrepel)
library(lme4)
library(lmerTest)
library(cowplot)
library(ggpmisc)
library(ggpubr)
library(reshape2)




```
#Make data frames
##External
```{r}


imputedBias.1_MNAR_mean <-
cbind(
summary_MICErf_MNAR_All[["imputedBias.1"]][["mean"]],
summary_MICErf_MNAR_All_Toxin[["imputedBias.1"]][["mean"]],
summary_MICErf_MNAR_Company[["imputedBias.1"]][["mean"]],
summary_MICErf_MNAR_noMeta[["imputedBias.1"]][["mean"]],
summary_MICErf_strata_MNAR_Company[["imputedBias.1"]][["mean"]],
summary_MICErf_strata_MNAR_All[["imputedBias.1"]][["mean"]],
summary_missForest_MNAR_All[["imputedBias.1"]][["mean"]],
summary_missForest_MNAR_Company[["imputedBias.1"]][["mean"]],
summary_missForest_MNAR_noMeta[["imputedBias.1"]][["mean"]],
summary_missForest_strata_MNAR_Company[["imputedBias.1"]][["mean"]],
summary_missForest_strata_MNAR_All[["imputedBias.1"]][["mean"]]
)

imputedBias.1_MNAR_std<- 
cbind(
summary_MICErf_MNAR_All[["imputedBias.1"]][["std_dev"]],
summary_MICErf_MNAR_All_Toxin[["imputedBias.1"]][["std_dev"]],
summary_MICErf_MNAR_Company[["imputedBias.1"]][["std_dev"]],
summary_MICErf_MNAR_noMeta[["imputedBias.1"]][["std_dev"]],
summary_MICErf_strata_MNAR_Company[["imputedBias.1"]][["std_dev"]],
summary_MICErf_strata_MNAR_All[["imputedBias.1"]][["std_dev"]],
summary_missForest_MNAR_All[["imputedBias.1"]][["std_dev"]],
summary_missForest_MNAR_Company[["imputedBias.1"]][["std_dev"]],
summary_missForest_MNAR_noMeta[["imputedBias.1"]][["std_dev"]],
summary_missForest_strata_MNAR_Company[["imputedBias.1"]][["std_dev"]],
summary_missForest_strata_MNAR_All[["imputedBias.1"]][["std_dev"]]
                  )

rn <- c("5 %", "10 %", "20 %", "30 %", "40 %")
cn<- c("MICErf_All", 
       "MICErf_All_Toxin", 
       "MICErf_Company", 
       "MICErf_noMeta", 
       "MICErf_strata_Company", 
       "MICErf_strata_All", 
       "missForest_All", 
       "missForest_Company", 
       "missForest_noMeta", 
       "missForest_strata_Company", 
       "missForest_strata_All")

colnames(imputedBias.1_MNAR_mean) <- cn
rownames(imputedBias.1_MNAR_mean) <- rn
colnames(imputedBias.1_MNAR_std) <- cn
rownames(imputedBias.1_MNAR_std) <- rn

test<- melt(imputedBias.1_MNAR_std)
test2<-melt(imputedBias.1_MNAR_mean)
mimputedBias.1_MNAR <- cbind(test2, test[3])

colnames(mimputedBias.1_MNAR) <- c("Missing", "Imputation", "Mean", "std")

mimputedBias.1_MNAR["missType"] <- "MNAR"
```

```{r}
imputedBias.1<- rbind(mimputedBias.1_MCAR, mimputedBias.1_MAR, mimputedBias.1_MNAR)
imputedBias.1$metric <- "imputedBias.2"

# bias1<- rbind(as.data.frame(MCARbias1), as.data.frame(MARbias1), as.data.frame(MNARbias1))
# bias1$metric <- "imputedBias.2"
# colnames(bias1)<- colnames(imputedBias.1)
# bias1 <-bias1[,1:6]

imputedBias.1 <- rbind(bias1, imputedBias.1)



imputedBias.2<- rbind(mimputedBias.2_MCAR, mimputedBias.2_MAR, mimputedBias.2_MNAR)
imputedBias.2$metric <- "imputedBias.2"

# bias2<- rbind(as.data.frame(MCARbias2), as.data.frame(MARbias2), as.data.frame(MNARbias2))
# bias2$metric <- "imputedBias.2"
# colnames(bias2)<- colnames(imputedBias.2)
# bias2 <-bias2[,1:6]

imputedBias.2 <- rbind(bias2, imputedBias.2)


```


```{r}
ExternalData <- rbind(imputedBias.2, imputedBias.1)


ExternalData$Missing<-(unlist(ExternalData$Missing))
ExternalData$Missing<-factor(ExternalData$Missing, levels = rn)

ExternalData$missType<-(unlist(ExternalData$missType))
ExternalData$missType<-factor(ExternalData$missType)

ExternalData$Imputation<-(unlist(ExternalData$Imputation))
ExternalData$Imputation<-factor(ExternalData$Imputation)

ExternalData$Mean<-(unlist(ExternalData$Mean))
ExternalData$std<-(unlist(ExternalData$std))

ExternalData$metric<-(unlist(ExternalData$metric))
ExternalData$metric<-factor(ExternalData$metric)

ExternalData2769<- ExternalData
ExternalData2769$sampleSize <- 2769

save(ExternalData2769, file = "ExternalMetricPlotData2769.Rdata")

```

##Interal
```{r}


partialMAE_MCAR_mean <-
cbind(
summary_MICErf_MCAR_All[["partialMAE"]][["mean"]],
summary_MICErf_MCAR_All_Toxin[["partialMAE"]][["mean"]],
summary_MICErf_MCAR_Company[["partialMAE"]][["mean"]],
summary_MICErf_MCAR_noMeta[["partialMAE"]][["mean"]],
summary_MICErf_strata_MCAR_Company[["partialMAE"]][["mean"]],
summary_MICErf_strata_MCAR_All[["partialMAE"]][["mean"]],
summary_missForest_MCAR_All[["partialMAE"]][["mean"]],
summary_missForest_MCAR_Company[["partialMAE"]][["mean"]],
summary_missForest_MCAR_noMeta[["partialMAE"]][["mean"]],
summary_missForest_strata_MCAR_Company[["partialMAE"]][["mean"]],
summary_missForest_strata_MCAR_All[["partialMAE"]][["mean"]]
)

partialMAE_MCAR_std<- 
cbind(
summary_MICErf_MCAR_All[["partialMAE"]][["std_dev"]],
summary_MICErf_MCAR_All_Toxin[["partialMAE"]][["std_dev"]],
summary_MICErf_MCAR_Company[["partialMAE"]][["std_dev"]],
summary_MICErf_MCAR_noMeta[["partialMAE"]][["std_dev"]],
summary_MICErf_strata_MCAR_Company[["partialMAE"]][["std_dev"]],
summary_MICErf_strata_MCAR_All[["partialMAE"]][["std_dev"]],
summary_missForest_MCAR_All[["partialMAE"]][["std_dev"]],
summary_missForest_MCAR_Company[["partialMAE"]][["std_dev"]],
summary_missForest_MCAR_noMeta[["partialMAE"]][["std_dev"]],
summary_missForest_strata_MCAR_Company[["partialMAE"]][["std_dev"]],
summary_missForest_strata_MCAR_All[["partialMAE"]][["std_dev"]]
                  )

rn <- c("5 %", "10 %", "20 %", "30 %", "40 %")
cn<- c("MICErf_All", 
       "MICErf_All_Toxin", 
       "MICErf_Company", 
       "MICErf_noMeta", 
       "MICErf_strata_Company", 
       "MICErf_strata_All", 
       "missForest_All", 
       "missForest_Company", 
       "missForest_noMeta", 
       "missForest_strata_Company", 
       "missForest_strata_All")

colnames(partialMAE_MCAR_mean) <- cn
rownames(partialMAE_MCAR_mean) <- rn
colnames(partialMAE_MCAR_std) <- cn
rownames(partialMAE_MCAR_std) <- rn

test<- melt(partialMAE_MCAR_std)
test2<-melt(partialMAE_MCAR_mean)
mpartialMAE_MCAR <- cbind(test2, test[3])

colnames(mpartialMAE_MCAR) <- c("Missing", "Imputation", "Mean", "std")

mpartialMAE_MCAR["missType"] <- "MCAR"
```

```{r}
NRMSE<- rbind(mNRMSE_MCAR, mNRMSE_MAR, mNRMSE_MNAR)
NRMSE$metric <- "NRMSE"

fullMAE<- rbind(mfullMAE_MCAR, mfullMAE_MAR, mfullMAE_MNAR)
fullMAE$metric <- "fullMAE"

partialMAE<- rbind(mpartialMAE_MCAR, mpartialMAE_MAR, mpartialMAE_MNAR)
partialMAE$metric <- "partialMAE"

InternalData2769<- rbind(NRMSE, fullMAE, InternalData)
InternalData2769$sampleSize <- 2769

save(InternalData2769, file = "InternalMetricPlotData2769.Rdata")
```



#main figures

```{r}
 scm <- scale_color_manual(values = c(
    "incomplete" ="black",
  "MICErf_All" = "#2dff2a", 
  "MICErf_All_Toxin" = "#34d34a", 
  "MICErf_Company" = "#3aa869" , 
  "MICErf_noMeta" = "#417c89" , 
  "MICErf_strata_Company" = "#4751a8", 
  "MICErf_strata_All" = "#4e25c8", 
  "missForest_All" = "#fffb20" ,
  "missForest_Company" = "#fac318" , 
  "missForest_noMeta" = "#f68c10", 
  "missForest_strata_Company" = "#f15408",
  "missForest_strata_All" = "#a51407")) 
sfm <- scale_fill_manual(values = c(
   "incomplete" ="black",
  "MICErf_All" = "#2dff2a", 
  "MICErf_All_Toxin" = "#34d34a", 
  "MICErf_Company" = "#3aa869" , 
  "MICErf_noMeta" = "#417c89" , 
  "MICErf_strata_Company" = "#4751a8", 
  "MICErf_strata_All" = "#4e25c8", 
  "missForest_All" = "#fffb20" ,
  "missForest_Company" = "#fac318" , 
  "missForest_noMeta" = "#f68c10", 
  "missForest_strata_Company" = "#f15408",
  "missForest_strata_All" = "#a51407")) 

```
##External
```{r}
mainExternalPlot <- ggplot(data = ExternalData2769, aes(x = Missing, y = Mean, color = Imputation, group = Imputation)) + 
  geom_point(size = 2) +
  geom_line(aes(group = Imputation)) +
  geom_ribbon(aes(x = Missing,
                  y = Mean,
                  fill = Imputation,
                  ymin = Mean - std,
                  ymax = Mean + std), 
              alpha = 0.2, 
              color = NA) +
                labs(x = "Missing",
                     colour = "Imputation") +
                theme_bw() + 
                  theme(axis.title.y = element_blank(),
                        legend.position = "bottom",
                        strip.background = element_rect(fill = "white", 
                                                        color = "white"),
                        axis.title.x = element_blank(),
                        panel.spacing = unit(0, "lines")) +
   facet_grid(metric~missType, scales = "free_y")+
   scm +
   sfm
                
ggsave(file=paste("External plot main.pdf",sep=""), plot=mainExternalPlot, height = 6, width = 9)
ggsave(file=paste("External plot main.svg",sep=""), plot=mainExternalPlot, height = 6, width = 9)


test <- ExternalData2769[which(ExternalData2769$metric=="imputedBias.1"),]
test<- test[which(test$missType=="MCAR"),]
test <- test[which(test$Imputation == "missForest_All"),]
ggplot(data = test, aes(x = Missing, y = Mean, color = Imputation, group = Imputation)) + 
  geom_point(size = 2)

```

##Internal
```{r}
mainInternalPlot<- ggplot(data = InternalData2769, aes(x = Missing, y = Mean, color = Imputation, group = Imputation)) + 
                    geom_point(size = 2) +
                    geom_line(aes(group = Imputation)) +
                    geom_ribbon(aes(x = Missing,
                                    y = Mean,
                                    fill = Imputation,
                                    ymin = Mean - std,
                                    ymax = Mean + std), 
                                alpha = 0.2, 
                                color = NA) +
                                  labs(x = "Missing",
                                       colour = "Imputation") +
                                  theme_bw() + 
                                    theme(axis.title.y = element_blank(),
                                          legend.position = "none",
                                          strip.background = element_rect(fill = "white", 
                                                                          color = "white"),
                                          axis.title.x = element_blank(),
                                          panel.spacing = unit(0, "lines")) +
                     facet_grid(metric~missType, scales = "free_y")+
                    scm +
                    sfm

ggsave(file=paste("Internal plot main.pdf",sep=""), plot=mainInternalPlot, height = 9, width = 9)
ggsave(file=paste("Internal plot main.svg",sep=""), plot=mainInternalPlot, height = 9, width = 9)

```


#sup mat figures
##NRMSE
```{r}

############################################################################# NRMSE

idx <- InternalData2769[which(InternalData2769$metric == "NRMSE"),]
idy <- InternalData500[which(InternalData500$metric == "NRMSE"),]
idx <- InternalData50[which(InternalData50$metric == "NRMSE"),]

NRMSE <- rbind(InternalData2769[idx,], InternalData500[idy,], InternalData50[idz,])


supmatNRMSE <- ggplot(data = NRMSE, aes(x = Missing, y = Mean, color = Imputation, group = Imputation)) + 
  geom_point(size = 2) +
  geom_line(aes(group = Imputation)) +
  geom_ribbon(aes(x = Missing,
                  y = Mean,
                  fill = Imputation,
                  ymin = Mean - std,
                  ymax = Mean + std), 
              alpha = 0.2, 
              color = NA) +
                labs(x = "Missing",
                     colour = "Imputation") +
                theme_bw() + 
                  theme(axis.title.y = element_blank(),
                        legend.position = "bottom",
                        strip.background = element_rect(fill = "white", 
                                                        color = "white"),
                        axis.title.x = element_blank(),
                        panel.spacing = unit(0, "lines")) +
   facet_grid(sampleSize~missType, scales = "free_y") +
  scm +
  sfm

leg <- get_legend(supmatNRMSE)

# Convert to a ggplot and print
internalLegend <- as_ggplot(leg)

supmatNRMSE <- supmatNRMSE + theme(legend.position = "none")    

ggsave(file=paste("NRMSE supmat.pdf",sep=""), plot=supmatNRMSE, height = 9, width = 9)
ggsave(file=paste("NRMSE supmat.svg",sep=""), plot=supmatNRMSE, height = 9, width = 9)
ggsave(file=paste("InternalLegend.pdf",sep=""), plot=internalLegend, width = 9)
ggsave(file=paste("InternalLegend.svg",sep=""), plot=internalLegend, width = 9)


```

##fullMAE
```{r}
############################################################################# fullMAE
idx <- InternalData2769[which(InternalData2769$metric == "fullMAE"),]
idy <- InternalData500[which(InternalData500$metric == "fullMAE"),]
idx <- InternalData50[which(InternalData50$metric == "fullMAE"),]

fullMAE <- rbind(InternalData2769[idx,], InternalData500[idy,], InternalData50[idz,])


supmatfullMAE <- ggplot(data = fullMAE, aes(x = Missing, y = Mean, color = Imputation, group = Imputation)) + 
  geom_point(size = 2) +
  geom_line(aes(group = Imputation)) +
  geom_ribbon(aes(x = Missing,
                  y = Mean,
                  fill = Imputation,
                  ymin = Mean - std,
                  ymax = Mean + std), 
              alpha = 0.2, 
              color = NA) +
                labs(x = "Missing",
                     colour = "Imputation") +
                theme_bw() + 
                  theme(axis.title.y = element_blank(),
                        legend.position = "none",
                        strip.background = element_rect(fill = "white", 
                                                        color = "white"),
                        axis.title.x = element_blank(),
                        panel.spacing = unit(0, "lines")) +
   facet_grid(sampleSize~missType, scales = "free_y") +
  scm +
  sfm

ggsave(file=paste("fullMAE supmat.pdf",sep=""), plot=supmatfullMAE, height = 9, width = 9)
ggsave(file=paste("fullMAE supmat.svg",sep=""), plot=supmatfullMAE, height = 9, width = 9)
```

##partial MAE
```{r}

############################################################################# partialMAE

idx <- InternalData2769[which(InternalData2769$metric == "partialMAE"),]
idy <- InternalData500[which(InternalData500$metric == "partialMAE"),]
idx <- InternalData50[which(InternalData50$metric == "partialMAE"),]

partialMAE <- rbind(InternalData2769[idx,], InternalData500[idy,], InternalData50[idz,])


supmatpartialMAE <- ggplot(data = partialMAE, aes(x = Missing, y = Mean, color = Imputation, group = Imputation)) + 
  geom_point(size = 2) +
  geom_line(aes(group = Imputation)) +
  geom_ribbon(aes(x = Missing,
                  y = Mean,
                  fill = Imputation,
                  ymin = Mean - std,
                  ymax = Mean + std), 
              alpha = 0.2, 
              color = NA) +
                labs(x = "Missing",
                     colour = "Imputation") +
                theme_bw() + 
                  theme(axis.title.y = element_blank(),
                        legend.position = "none",
                        strip.background = element_rect(fill = "white", 
                                                        color = "white"),
                        axis.title.x = element_blank(),
                        panel.spacing = unit(0, "lines")) +
   facet_grid(sampleSize~missType, scales = "free_y") +
  scm +
  sfm

ggsave(file=paste("partialMAE supmat.pdf",sep=""), plot=supmatpartialMAE, height = 9, width = 9)
ggsave(file=paste("partialMAE supmat.svg",sep=""), plot=supmatpartialMAE, height = 9, width = 9)

```
##bias 1
```{r}
############################################################################# imputedBias.1
idx <- InternalData2769[which(InternalData2769$metric == "imputedBias.1"),]
idy <- InternalData500[which(InternalData500$metric == "imputedBias.1"),]
idx <- InternalData50[which(InternalData50$metric == "imputedBias.1"),]

imputedBias.1 <- rbind(InternalData2769[idx,], InternalData500[idy,], InternalData50[idz,])


supmatimputedBias.1 <- ggplot(data = partialMAE, aes(x = Missing, y = Mean, color = Imputation, group = Imputation)) + 
  geom_point(size = 2) +
  geom_line(aes(group = Imputation)) +
  geom_ribbon(aes(x = Missing,
                  y = Mean,
                  fill = Imputation,
                  ymin = Mean - std,
                  ymax = Mean + std), 
              alpha = 0.2, 
              color = NA) +
                labs(x = "Missing",
                     colour = "Imputation") +
                theme_bw() + 
                  theme(axis.title.y = element_blank(),
                        legend.position = "bottom",
                        strip.background = element_rect(fill = "white", 
                                                        color = "white"),
                        axis.title.x = element_blank(),
                        panel.spacing = unit(0, "lines")) +
   facet_grid(sampleSize~missType, scales = "free_y") +
  scm +
  sfm

leg <- get_legend(supmatimputedBias.1)

# Convert to a ggplot and print
externalLegend <- as_ggplot(leg)

supmatimputedBias.1 <- supmatimputedBias.1 + theme(legend.position = "none")    

ggsave(file=paste("imputedBias.1 supmat.pdf",sep=""), plot=supmatimputedBias.1, height = 9, width = 9)
ggsave(file=paste("imputedBias.1 supmat.svg",sep=""), plot=supmatimputedBias.1, height = 9, width = 9)
ggsave(file=paste("ExternalLegend.pdf",sep=""), plot=externalLegend, width = 9)
ggsave(file=paste("ExternalLegend.svg",sep=""), plot=externalLegend, width = 9)

```
##bias 2
```{r}
############################################################################# imputedBias.2

idx <- InternalData2769[which(InternalData2769$metric == "imputedBias.2"),]
idy <- InternalData500[which(InternalData500$metric == "imputedBias.2"),]
idx <- InternalData50[which(InternalData50$metric == "imputedBias.2"),]

imputedBias.2 <- rbind(InternalData2769[idx,], InternalData500[idy,], InternalData50[idz,])


supmatimputedBias.2 <- ggplot(data = partialMAE, aes(x = Missing, y = Mean, color = Imputation, group = Imputation)) + 
  geom_point(size = 2) +
  geom_line(aes(group = Imputation)) +
  geom_ribbon(aes(x = Missing,
                  y = Mean,
                  fill = Imputation,
                  ymin = Mean - std,
                  ymax = Mean + std), 
              alpha = 0.2, 
              color = NA) +
                labs(x = "Missing",
                     colour = "Imputation") +
                theme_bw() + 
                  theme(axis.title.y = element_blank(),
                        legend.position = "none",
                        strip.background = element_rect(fill = "white", 
                                                        color = "white"),
                        axis.title.x = element_blank(),
                        panel.spacing = unit(0, "lines")) +
   facet_grid(sampleSize~missType, scales = "free_y") +
  scm +
  sfm

ggsave(file=paste("imputedBias.2 supmat.pdf",sep=""), plot=supmatimputedBias.2, height = 9, width = 9)
ggsave(file=paste("imputedBias.2 supmat.svg",sep=""), plot=supmatimputedBias.2, height = 9, width = 9)

```


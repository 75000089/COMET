---
title: "imputation"
author: "Lucy Grigoroff"
date: "2023-08-28"
output: html_document
---
```{r}
set.seed(1)
```


#Complete cases dataset
control is defined by animal numers 1-10 (dose group 1) or timepoint 0
low dose is animal numbers 11-20 (dose group 2) and not timepoint 0
high dose is animal numers 21-30 (dose group 3) and timepoint not 0
```{r cars}
 library(missForest)
 library(mice)
 library(CALIBERrfimpute)
 library(randomForest)
 library(missMethods)
 library(lpSolve)
# devtools::install_github("strengejacke/sjmisc")
 library(sjmisc)
 library(tidyverse)
 library(ggpubr)
library(reshape2)
library(ggpmisc)
library(egg)
library(devEMF)
library(see)
load("/Users/lucygrigoroff/Downloads/new_clinchem_2SD_removed_edited.rda")
df <- new_clinchem

#set up doseFlag column with control, low, high

df <- df %>% mutate(doseFlag =
                     case_when((Dose_group == 1 | Timepoint == 0) ~ "Control",
                               (Dose_group == 2 & Timepoint != 0) ~ "low",
                              (Dose_group == 3 & Timepoint != 0) ~ "high")
)


#serum data frame
#SERUM only has 3 timepoints, 24, 48 and 168
Sdf<- df[,c(1:5,10:13,20:30,32,33)]
idx <- which(Sdf$Timepoint == 24 | df$Timepoint == 48 |df$Timepoint == 168)
Sdf <- Sdf[idx,]
#complete cases
idx<- which(rowSums(is.na(Sdf[10:20])) > 0)
SCdf<-Sdf[-idx,]

SCdf <-SCdf%>%relocate("doseFlag", .before = "S_Creatinine" ) %>% relocate("S_Comments", .before = "S_Creatinine")

# #URINE data frame
# Udf<-df[,c(1:5,10:18,31,33)]
# #complete cases
# idx<- which(rowSums(is.na(Udf[11:14])) > 0)
# UCdf<-Udf[-idx,]
#
# #NA summary
# #SERUM
# colSums(is.na(Sdf))
# as.data.frame(sapply(Sdf[10:20], function(x) sum(is.na(x))/8460*100))
#
# #URINE
# colSums(is.na(Udf))
# as.data.frame(sapply(Udf[11:14], function(x) sum(is.na(x))/25350*100))
```

#choose data size
full, 500 or 10
```{r}

# unique(SCdf$Company)
# random_sample <- data[sample(nrow(data), 50), ]


R <- which(SCdf$Company == "R")
R<- SCdf[R,]
R <- R[sample(nrow(R), 100), ]

D <- which(SCdf$Company == "D")
D <- SCdf[D,]
D <- D[sample(nrow(D), 100), ]

L <- which(SCdf$Company == "L")
L <- SCdf[L,]
L <- L[sample(nrow(L), 100), ]

N <- which(SCdf$Company == "N")
N <- SCdf[N,]
N <- N[sample(nrow(N), 100), ]

S <- which(SCdf$Company == "S")
S <- SCdf[S,]
S <- S[sample(nrow(S), 100), ]

SCdf<-rbind(R, D, L, N, S)

SCdf500full <- SCdf

```


#set up percentages of missingness
```{r}
p <- (cbind(0.05, 0.1, 0.2, 0.3, 0.4))

#for graphs in METRICS and FIGURES
cat(paste(shQuote(paste0( p[1,] * 100, " %"), type="cmd"), collapse=", "))
rn<-c("5 %", "10 %", "20 %", "30 %", "40 %")
```

#list of colnames for MCAR missingess
```{r}
MCARcols <- c("S_Creatinine", "S_Urea_nitrogen", "S_ALT", "S_AST", "S_Glucose","S_Sodium", "S_Potassium", "S_Calcium", "S_Phosphorus", "S_Albumin", "S_Total_protein")

#cat(paste(shQuote(colnames(SCdf), type="cmd"), collapse=", "))

cnames<-c("Company", "Study_id", "Toxin", "Target", "Key", "Animal_no.", "Timepoint", "Sacrifice_subgroup", "Dose_group", "doseFlag", "S_Comments", "S_Creatinine", "S_Urea_nitrogen", "S_ALT", "S_AST", "S_Glucose", "S_Sodium", "S_Potassium", "S_Calcium", "S_Phosphorus", "S_Albumin", "S_Total_protein")

```



dose groups, anything thatâ€™s in the control group (animal no. 1-10 or timepoint 0 = 1, animal no 11-20 and not timepoint 0 =2, animal no 20-30 and not timepoint 0=3)

control <- df%>%filter(Dose_group == 1 | Timepoint == 0)
low_dose <- df%>%filter(Dose_group == 2 & Timepoint != 0, )
high_dose <- df%>%filter(Dose_group == 3 & Timepoint != 0, )

MAR
Company and comments "IS=insufficient volume", "IS=Insufficient sample" "No internal code;  IS=Insufficient sample" "No internal code;  IS=Insufficient sample; NC=Not calculated"

missForest: control+low+high: clinchem_params + doseFlag + animal_no + timepoint + sacrifice + company


#MISSINGNESS
Using complete cases for serum, create missingness at varying percentages (5, 10, 20, 30 40)
```{r}
#to not create missinginess in the following
miscols <- c(1:11)

#MAR
MAR <- list()
for (j in (p)) {
  placeHolder <- paste0("missing ", j * 100, " %")

  mSdf <- list()
  test <- SCdf[, miscols]
  for (i in start:ncol(SCdf)) {
    #missingness
    mSdf[[i]] <-
      missMethods::delete_MAR_1_to_x(ds = SCdf,
                                      p = j,
                                      cols_mis = c(i),
                                      cols_ctrl = c("Company"),
                                      x = 3)
    test[, i] <- (mSdf[[i]][[i]])
  }
  new_list <- setNames(list(test), placeHolder)
  MAR <- append(MAR, new_list)
}

for(j in 1:length(MAR)){
  MAR[[j]] <- setNames(MAR[[j]], cnames)
}

#MNAR
MNAR <- list()
for (j in (p)) {
  placeHolder <- paste0("missing ", j * 100, " %")

  mSdf <- list()
  test <- SCdf[, miscols]
  for (i in start:ncol(SCdf)) {
    #missingness
    mSdf[[i]] <-
      missMethods::delete_MNAR_1_to_x(ds = SCdf,
                                      p = j,
                                      cols_mis = c(i),
                                      x = 3)
    test[, i] <- (mSdf[[i]][[i]])
  }
  new_list <- setNames(list(test), placeHolder)
  MNAR <- append(MNAR, new_list)
}

for(j in 1:length(MNAR)){
  MNAR[[j]] <- setNames(MNAR[[j]], cnames)
}

#MCAR
MCAR<-list()
for(j in p) {
  placeHolder <- paste0("missing ", j * 100, " %")
  mSdf <- list()
  #missingness
  mSdf[[i]] <- missMethods::delete_MCAR(ds = SCdf, p = j, MCARcols)
  new_list <- setNames(list(mSdf[[i]]), placeHolder)
  MCAR <- append(MCAR, new_list)

}

rm(mSdf, new_list, test, new_clinchem,Sdf, df)


MCAR500<-MCAR
MAR500<-MAR
MNAR500<-MNAR
```


######Start
#choose columns for imputation input
```{r}
SCdf <- SCdf500full 

impcols<-
  #NULL
  #"Company"
  c("Company", "Timepoint", "Animal_no.", "doseFlag", "Sacrifice_subgroup", "Target")
  #c("Company", "Timepoint", "Animal_no.", "doseFlag", "Sacrifice_subgroup", "Target", "Toxin")

#column to begin creating missingness
start <- which(colnames(SCdf) == "S_Creatinine")
#or start<-12
end<-ncol(SCdf)

```
#choose missingess method

Need to change the way the eg CALIBER_MAR list is set up. Use paste 
```{r}
t<- MCAR
full<-SCdf[,start:end]
#full500<-full

```

#set up original Albumin and Total Protein Bias
```{r}
#set up external checks
original.lm.1 <- summary(lm(S_Albumin ~ S_Total_protein, data = SCdf))
# original.lm.1[["r.squared"]]
original <-original.lm.1[["coefficients"]][2,1]

missed<-list()
missedSummary<-list()
missedBias<-list()
for(j in 1:length(t)){
  missedSummary[[j]] <- summary(lm(S_Albumin ~ S_Total_protein, data = t[[j]], na.action = na.omit))
  missed[[j]] <-missedSummary[[j]][["coefficients"]][2,1]
  missedBias[[j]] <- abs((original - missed[[j]])/original)

}
```
#set up original AST adn ALT
```{r}
####################
original.lm.2 <- summary(lm(S_ALT ~ S_AST, data = SCdf))
# original.lm.1[["r.squared"]]
original2 <-original.lm.2[["coefficients"]][2,1]

missed2<-list()
missedSummary2<-list()
missedBias2<-list()
for(j in 1:length(t)){
  missedSummary2[[j]] <- summary(lm(S_ALT ~ S_AST, data = t[[j]], na.action = na.omit))
  missed2[[j]] <-missedSummary2[[j]][["coefficients"]][2,1]
  missedBias2[[j]] <- abs((original2 - missed2[[j]])/original2)
}

```


#IMPUTATION

##MICErf
Repeat the below process for MCAR, MAR and MNAR
```{r}

 res<-list()
for(k in 1:20){
#full<-SCdf[,12:22]
test<-list()
imp<-list()
imp2<-list()
imputedonly<-list()
MICErf<-list()
FULL<-list()
PARTIAL<-list()
for(j in 1:length(t)){
  placeHolder <- paste0("FULLimputed ", p[j] * 100, " %")
  placeHolder2 <- paste0("imputed vs full ", p[j] * 100, " %")
  
  if(length(impcols) == 1){
   x<-as.data.frame(SCdf[,impcols])
   colnames(x) <- c("Company")
 }

  if(length(impcols) > 1){
   x<-SCdf[,impcols]
  }

   if(length(impcols) < 1){
   x<-as.data.frame(rep_len(x = 1, length.out = nrow(SCdf)))
 }
  
  #make predictors numeric

 x[sapply(x, is.character)] <- lapply(x[sapply(x, is.character)], as.factor)
 x[sapply(x, is.factor)] <- lapply(x[sapply(x, is.factor)], as.numeric)
 
#make the predictor matrix using all covariates (including clin_chem parameters)
x<-cbind(x,t[[j]][,start:end])
init = mice(x, maxit=0) 
predM = init$predictorMatrix

#Do imputation
imp[[j]]<-mice(data = x, method="rf", predictorMatrix = predM)
imp2[[j]]<-merge_imputations(dat = x, imp = imp[[j]])
idx<- as.data.frame(which(is.na(t[[j]][,start:end]), arr.ind=TRUE))
idx$imputed<-idx$original<-NA

for(i in 1:nrow(idx)){
  idx$original[i]<-unlist(full[idx$row[i],idx$col[i]])
  idx$imputed[i]<-imp2[[j]][idx$row[i],idx$col[i]]
  imputedonly[[j]]<-idx
}

new_list <- setNames(list(imp2[[j]]), placeHolder)
FULL <- append(FULL, new_list)  

new_list2 <- setNames(list(imputedonly[[j]]), placeHolder2)
PARTIAL <- append(PARTIAL, new_list2) 
}

MICErf<- append(MICErf, list(PARTIAL = PARTIAL,
                             FULL = FULL))

#NRMSE + fullMAE
nrmse <-list()
fullmae<-list()
NRMSE<-list()
fullMAE<-list()
for(j in 1:length(MICErf[["FULL"]])){
  
placeHolder3 <- paste0( p[,j] * 100, " % missing")  

xi<- as.matrix(MICErf[["FULL"]][[j]])
xt<-as.matrix(SCdf[,start:end])
xm<-as.matrix(t[[j]][,start:end]) 
  
nrmse[[j]]<-missForest::nrmse(ximp = xi, xmis = xm, xtrue = xt)

new_list <- setNames((nrmse[j]), placeHolder3)
NRMSE <- append(NRMSE, new_list) 

fullmae[j] <- mean(abs(xt - xi))

new_list2 <- setNames((fullmae[j]), placeHolder3)
fullMAE <- append(fullMAE, new_list2) 

}
 
#partialMAE
 partialmae <- list()  
 partialMAE<-list()
  for(j in 1:length(MICErf[["PARTIAL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
    
  xt <- MICErf[["PARTIAL"]][[j]][["original"]]
  xi <- MICErf[["PARTIAL"]][[j]][["imputed"]]
  
  partialmae[j] <- mean(abs(xt - xi))
  
  new_list <- setNames((partialmae[j]), placeHolder3)
  partialMAE <- append(partialMAE, new_list) 
  }
 
#External check 1 MICErf
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.1 <- list()
for(j in 1:length(MICErf[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_Albumin ~ S_Total_protein, data = MICErf[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original - imputed[[j]])/original)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.1 <- append(imputedBias.1, new_list) 
}

#External Check 2 MICErf
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.2 <- list()
for(j in 1:length(MICErf[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_ALT ~ S_AST, data = MICErf[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original2 - imputed[[j]])/original2)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.2 <- append(imputedBias.2, new_list) 
}


MICErf<- append(MICErf, list(NRMSE = NRMSE,
                             partialMAE = partialMAE,
                             fullMAE = fullMAE,
                             imputedBias.1 = imputedBias.1,
                             imputedBias.2 = imputedBias.2))


res[[k]] <- MICErf
}

#nameing

 if((MCAR[1] %in% t[1])){
   missing<-"_MCAR"
 }

if((MAR[1] %in% t[1]) ){
  missing <-"_MAR"
}

if((MNAR[1] %in% t[1]) ){
  missing <-"_MNAR"
}

if(length(impcols) == 1){
   impco<- "_Company"
 }

if(length(impcols) > 1 && !("Toxin" %in% impcols)){
  impco<- "_All"
  }

if(length(impcols) > 1 && "Toxin" %in% impcols){
  impco<- "_All_Toxin"
  }

 if(length(impcols) < 1){
   impco<-"_noMeta"
 }

list_name <- paste("MICErf", missing, impco, sep = "")
assign(list_name, res, envir = .GlobalEnv)


n_entries <- length(res)
metrics <- c("NRMSE", "partialMAE", "fullMAE", "imputedBias.1", "imputedBias.2")

# Initialize a list to store the results
results <- list()

# Loop through the metrics
for (metric in metrics) {
  result_matrix <- matrix(NA, nrow = n_entries, ncol = length(res[[1]][[metric]]))
  
  # Loop through the list and extract the current metric values into the matrix
  for (i in 1:n_entries) {
    result_matrix[i, ] <- unlist(res[[i]][[metric]])
  }
  
  # Calculate mean and standard deviation for each column
  mean_values <- apply(result_matrix, 2, mean)
  std_dev_values <- apply(result_matrix, 2, sd)
  
  results[[metric]] <- list(mean = mean_values, std_dev = std_dev_values)
}

list_name <- paste("summary_MICErf", missing, impco, sep = "")
assign(list_name, results, envir = .GlobalEnv)



#```

##MICErf strata
#Repeat the below process for MCAR, MAR and MNAR
#```{r}


  res<-list()
for(k in 1:20){
#full<-SCdf[,12:22]
test<-list()
imp<-list()
imp2<-list()
imputedonly<-list()
MICErf<-list()
FULL<-list()
PARTIAL<-list()
for(j in 1:length(t)){
  placeHolder <- paste0("FULLimputed ", p[j] * 100, " %")
  placeHolder2 <- paste0("imputed vs full ", p[j] * 100, " %")
  
    if(length(impcols) == 1){
   x<-as.data.frame(SCdf[,impcols])
   colnames(x) <- c("Company")
 }

  if(length(impcols) > 1){
   x<-SCdf[,impcols]
  }

   if(length(impcols) < 1){
   x<-as.data.frame(rep_len(x = 1, length.out = nrow(SCdf)))
 }
  
  #make predictors numeric

 x[sapply(x, is.character)] <- lapply(x[sapply(x, is.character)], as.factor)
 x[sapply(x, is.factor)] <- lapply(x[sapply(x, is.factor)], as.numeric)
 
#make the predictor matrix using all covariates (including clin_chem parameters)
x<-cbind(x,t[[j]][,start:end])
init = mice(x, maxit=0) 
predM = init$predictorMatrix

#Do imputation
# imp[[j]]<-mice(data = x, method="rf", predictorMatrix = predM)
# imp2[[j]]<-merge_imputations(dat = x, imp = imp[[j]])


# #Do imputation
# 
stratimp2<- list()
stratimp<-list()
for(i in 1:5){
stratimp<-mice(data = x[which(x$Company == i),], method="rf", predictorMatrix = predM)
stratimp2[[i]]<-merge_imputations(dat = x[which(x$Company == i),], imp = stratimp)

#if the number of columns are less than 11, then one of them did not contain an NA post stratification, which will prevent the next step. If this is the case, find the column, reattach is and put it in the correct/same order as the others. May only work when it's one column missing

if(ncol(stratimp2[[i]]) < 11){
  #find missing column
base <- c("S_Creatinine", "S_Urea_nitrogen", "S_ALT", "S_AST", "S_Glucose", "S_Sodium", "S_Potassium", "S_Calcium", "S_Phosphorus", "S_Albumin", "S_Total_protein")
missing_cols <- setdiff(base, colnames(stratimp2[[i]]))

#reattach the column
stratimp2[[i]][,missing_cols] <- x[which(x$Company == i), missing_cols]

# Reorder columns in the data frame
stratimp2[[i]] <- stratimp2[[i]][, base]
}

}

#must stack the companies in the correct order ("R" "D" "L" "N" "S" so 4, 1, 2, 3, 5)
test <- rbind(stratimp2[[4]], stratimp2[[1]], stratimp2[[2]], stratimp2[[3]], stratimp2[[5]])

imp2[[j]] <- test

 idx<- as.data.frame(which(is.na(t[[j]][,start:end]), arr.ind=TRUE))
 idx$imputed<-idx$original<-NA
for(i in 1:nrow(idx)){
  idx$original[i]<-unlist(full[idx$row[i],idx$col[i]])
  idx$imputed[i]<-imp2[[j]][idx$row[i],idx$col[i]]
  imputedonly[[j]]<-idx
}

new_list <- setNames(list(imp2[[j]]), placeHolder)
FULL <- append(FULL, new_list)  

new_list2 <- setNames(list(imputedonly[[j]]), placeHolder2)
PARTIAL <- append(PARTIAL, new_list2) 
}

MICErf<- append(MICErf, list(PARTIAL = PARTIAL,
                             FULL = FULL))

#NRMSE + fullMAE
nrmse <-list()
fullmae<-list()
NRMSE<-list()
fullMAE<-list()
for(j in 1:length(MICErf[["FULL"]])){
  
placeHolder3 <- paste0( p[,j] * 100, " % missing")  

xi<- as.matrix(MICErf[["FULL"]][[j]])
xt<-as.matrix(SCdf[,start:end])
xm<-as.matrix(t[[j]][,start:end]) 
  
nrmse[[j]]<-missForest::nrmse(ximp = xi, xmis = xm, xtrue = xt)

new_list <- setNames((nrmse[j]), placeHolder3)
NRMSE <- append(NRMSE, new_list) 

fullmae[j] <- mean(abs(xt - xi))

new_list2 <- setNames((fullmae[j]), placeHolder3)
fullMAE <- append(fullMAE, new_list2) 

}
 
#partialMAE
 partialmae <- list()  
 partialMAE<-list()
  for(j in 1:length(MICErf[["PARTIAL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
    
  xt <- MICErf[["PARTIAL"]][[j]][["original"]]
  xi <- MICErf[["PARTIAL"]][[j]][["imputed"]]
  
  partialmae[j] <- mean(abs(xt - xi))
  
  new_list <- setNames((partialmae[j]), placeHolder3)
  partialMAE <- append(partialMAE, new_list) 
  }
 
#External check 1 MICErf
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.1 <- list()
for(j in 1:length(MICErf[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_Albumin ~ S_Total_protein, data = MICErf[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original - imputed[[j]])/original)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.1 <- append(imputedBias.1, new_list) 
}

#External Check 2 MICErf
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.2 <- list()
for(j in 1:length(MICErf[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_ALT ~ S_AST, data = MICErf[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original2 - imputed[[j]])/original2)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.2 <- append(imputedBias.2, new_list) 
}


MICErf<- append(MICErf, list(NRMSE = NRMSE,
                             partialMAE = partialMAE,
                             fullMAE = fullMAE,
                             imputedBias.1 = imputedBias.1,
                             imputedBias.2 = imputedBias.2))


res[[k]] <- MICErf
}

#nameing

 if((MCAR[1] %in% t[1])){
   missing<-"_MCAR"
 }

if((MAR[1] %in% t[1]) ){
  missing <-"_MAR"
}

if((MNAR[1] %in% t[1]) ){
  missing <-"_MNAR"
}

if(length(impcols) == 1){
   impco<- "_Company"
 }

if(length(impcols) > 1 && !("Toxin" %in% impcols)){
  impco<- "_All"
  }

if(length(impcols) > 1 && "Toxin" %in% impcols){
  impco<- "_All_Toxin"
  }

 if(length(impcols) < 1){
   impco<-"_noMeta"
 }

list_name <- paste("MICErf_strata", missing, impco, sep = "")
assign(list_name, res, envir = .GlobalEnv)


n_entries <- length(res)
metrics <- c("NRMSE", "partialMAE", "fullMAE", "imputedBias.1", "imputedBias.2")

# Initialize a list to store the results
results <- list()

# Loop through the metrics
for (metric in metrics) {
  result_matrix <- matrix(NA, nrow = n_entries, ncol = length(res[[1]][[metric]]))
  
  # Loop through the list and extract the current metric values into the matrix
  for (i in 1:n_entries) {
    result_matrix[i, ] <- unlist(res[[i]][[metric]])
  }
  
  # Calculate mean and standard deviation for each column
  mean_values <- apply(result_matrix, 2, mean)
  std_dev_values <- apply(result_matrix, 2, sd)
  
  results[[metric]] <- list(mean = mean_values, std_dev = std_dev_values)
}

list_name <- paste("summary_MICErf_strata", missing, impco, sep = "")
assign(list_name, results, envir = .GlobalEnv)



#```
##missForest
###missForest 
#```{r}


res<-list()
for(k in 1:20){
  
FULL<-list()
PARTIAL <- list()
missForest<-list()
imp <- list()
imputedonly<-list()
nrmse<-list()
NRMSE<-list()
for(j in 1:length(t)){
  placeHolder <- paste0("FULLimputed ", p[j] * 100, " %")
  placeHolder2 <- paste0("imputed vs full ", p[j] * 100, " %")
  placeHolder3<- paste0("NRMSE ", p[j] * 100, " % missing")
  
if(length(impcols) == 1){
   x<-as.data.frame(SCdf[,impcols])
   colnames(x) <- c("Company")
 }

  if(length(impcols) > 1){
   x<-SCdf[,impcols]
  }

   if(length(impcols) < 1){
   x<-as.data.frame(rep_len(x = 1, length.out = nrow(SCdf)))
 }  
  
  #make predictors factors (can also be numeric, just not characters, max of 53 categories per variable allowed)
 x[sapply(x, is.character)] <- lapply(x[sapply(x, is.character)], as.factor)
 
 #set up data frame used in imputation 
 x <- cbind(x,t[[1]][,start:end])
 
 #impute
 imp[[j]] <- missForest(xmis = x, ntree = 10, variablewise = F)
 
 #locate where in the complete data the NAs were created
idx<- as.data.frame(which(is.na(t[[j]][,start:end]), arr.ind=TRUE))

#make empty list to fill with original and imputed
idx$imputed<-idx$original<-NA

#start and end criteria 
start2 <- which(colnames(x) == "S_Creatinine")
end2 <- ncol(x)

for(i in 1:nrow(idx)){
  
  #fill original column
  idx$original[i]<-full[idx$row[i],idx$col[i]]
  #fill imputed column
  idx$imputed[i]<-imp[[j]][["ximp"]][,start2:end2][idx$row[i],idx$col[i]]
  #store imputed only for each percentage of missingness
  imputedonly[[j]]<-idx
}

new_list <- setNames(list(imp[[j]][["ximp"]][,start2:end2]), placeHolder)
FULL <- append(FULL, new_list)  

 new_list2 <- setNames(list(imputedonly[[j]]), placeHolder2)
 PARTIAL <- append(PARTIAL, new_list2) 

}

missForest<- append(missForest, list(PARTIAL = PARTIAL,
                                     FULL = FULL
                                     ))

#NRMSE + fullMAE
nrmse <-list()
fullmae<-list()
NRMSE<-list()
fullMAE<-list()
for(j in 1:length(missForest[["FULL"]])){
  
placeHolder3 <- paste0( p[,j] * 100, " % missing")  

xi<- as.matrix(missForest[["FULL"]][[j]])
xt<-as.matrix(SCdf[,start:end])
xm<-as.matrix(t[[j]][,start:end]) 
  
nrmse[[j]]<-missForest::nrmse(ximp = xi, xmis = xm, xtrue = xt)

new_list <- setNames((nrmse[j]), placeHolder3)
NRMSE <- append(NRMSE, new_list) 

fullmae[j] <- mean(abs(xt - xi))

new_list2 <- setNames((fullmae[j]), placeHolder3)
fullMAE <- append(fullMAE, new_list2) 

}
 
#partialMAE
 partialmae <- list()  
 partialMAE<-list()
  for(j in 1:length(missForest[["PARTIAL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
    
  xt <- missForest[["PARTIAL"]][[j]][["original"]]
  xi <- missForest[["PARTIAL"]][[j]][["imputed"]]
  
  partialmae[j] <- mean(abs(xt - xi))
  
  new_list <- setNames((partialmae[j]), placeHolder3)
  partialMAE <- append(partialMAE, new_list) 
  }
 
#External check 1 missForest
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.1 <- list()
for(j in 1:length(missForest[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")
  imputedSummary[[j]] <- summary(lm(S_Albumin ~ S_Total_protein, data = missForest[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original - imputed[[j]])/original)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.1 <- append(imputedBias.1, new_list)
}

#External check 2 missForest
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.2 <- list()
for(j in 1:length(missForest[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")
  imputedSummary[[j]] <- summary(lm(S_ALT ~ S_AST, data = missForest[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original2 - imputed[[j]])/original2)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.2 <- append(imputedBias.2, new_list)
}
 
missForest<- append(missForest, list(NRMSE =NRMSE,
                                     partialMAE = partialMAE,
                                     fullMAE = fullMAE ,
                                      imputedBias.1 = imputedBias.1,
                                      imputedBias.2 = imputedBias.2
                                     ))  

res[[k]] <- missForest
}
#nameing

 if((MCAR[1] %in% t[1])){
   missing<-"_MCAR"
 }

if((MAR[1] %in% t[1]) ){
  missing <-"_MAR"
}

if((MNAR[1] %in% t[1]) ){
  missing <-"_MNAR"
}

if(length(impcols) == 1){
   impco<- "_Company"
 }

if(length(impcols) > 1 && !("Toxin" %in% impcols)){
  impco<- "_All"
  }

if(length(impcols) > 1 && "Toxin" %in% impcols){
  impco<- "_All_Toxin"
  }

 if(length(impcols) < 1){
   impco<-"_noMeta"
 }

list_name <- paste("missForest", missing, impco, sep = "")
assign(list_name, res, envir = .GlobalEnv)

n_entries <- length(res)
metrics <- c("NRMSE", "partialMAE", "fullMAE", "imputedBias.1", "imputedBias.2")

# Initialize a list to store the results
results <- list()

# Loop through the metrics
for (metric in metrics) {
  result_matrix <- matrix(NA, nrow = n_entries, ncol = length(res[[1]][[metric]]))
  
  # Loop through the list and extract the current metric values into the matrix
  for (i in 1:n_entries) {
    result_matrix[i, ] <- unlist(res[[i]][[metric]])
  }
  
  # Calculate mean and standard deviation for each column
  mean_values <- apply(result_matrix, 2, mean)
  std_dev_values <- apply(result_matrix, 2, sd)
  
  results[[metric]] <- list(mean = mean_values, std_dev = std_dev_values)
}

list_name <- paste("summary_missForest", missing, impco, sep = "")
assign(list_name, results, envir = .GlobalEnv)

#```

###missForest strata
#```{r}


res<-list()
for(k in 1:20){
  
FULL<-list()
PARTIAL <- list()
missForest<-list()
imp <- list()
imputedonly<-list()
nrmse<-list()
NRMSE<-list()
for(j in 1:length(t)){
  placeHolder <- paste0("FULLimputed ", p[j] * 100, " %")
  placeHolder2 <- paste0("imputed vs full ", p[j] * 100, " %")
  placeHolder3<- paste0("NRMSE ", p[j] * 100, " % missing")
  
  
  if(length(impcols) == 1){
   x<-as.data.frame(SCdf[,impcols])
   colnames(x) <- c("Company")
 }

  if(length(impcols) > 1){
   x<-SCdf[,impcols]
  }

   if(length(impcols) < 1){
   x<-as.data.frame(rep_len(x = 1, length.out = nrow(SCdf)))
 }
  #make predictors factors (can also be numeric, just not characters, max of 53 categories per variable allowed)

 x[sapply(x, is.character)] <- lapply(x[sapply(x, is.character)], as.factor)
 
 #set up data frame used in imputation 
 x <- cbind(x,t[[1]][,start:end])
 
 #impute
 
  ##################
#rm(stratimp)
stratimp2<- list()
companies <- c("D", "L", "N", "R", "S")

for (z in 1:5) {
  stratimp2[[z]] <- missForest(xmis = x[x$Company == companies[z], ], ntree = 10, variablewise = FALSE)
}
test <- rbind(stratimp2[[1]][["ximp"]], stratimp2[[2]][["ximp"]], stratimp2[[3]][["ximp"]], stratimp2[[4]][["ximp"]], stratimp2[[5]][["ximp"]])

imp[[j]] <- test

 ##################
 #imp[[j]] <- missForest(xmis = x, ntree = 10, variablewise = F)
 
 #locate where in the complete data the NAs were created
idx<- as.data.frame(which(is.na(t[[j]][,start:end]), arr.ind=TRUE))

#make empty list to fill with original and imputed
idx$imputed<-idx$original<-NA

#start and end criteria 
start2 <- which(colnames(x) == "S_Creatinine")
end2 <- ncol(x)

for(i in 1:nrow(idx)){
  
  #fill original column
  idx$original[i]<-full[idx$row[i],idx$col[i]]
  #fill imputed column
  idx$imputed[i]<-imp[[j]][,start2:end2][idx$row[i],idx$col[i]]
  #store imputed only for each percentage of missingness
  imputedonly[[j]]<-idx
}

new_list <- setNames(list(imp[[j]][,start2:end2]), placeHolder)
FULL <- append(FULL, new_list)  

 new_list2 <- setNames(list(imputedonly[[j]]), placeHolder2)
 PARTIAL <- append(PARTIAL, new_list2) 

}

missForest<- append(missForest, list(PARTIAL = PARTIAL,
                                     FULL = FULL
                                     ))

#NRMSE + fullMAE
nrmse <-list()
fullmae<-list()
NRMSE<-list()
fullMAE<-list()
for(j in 1:length(missForest[["FULL"]])){
  
placeHolder3 <- paste0( p[,j] * 100, " % missing")  

xi<- as.matrix(missForest[["FULL"]][[j]])
xt<-as.matrix(SCdf[,start:end])
xm<-as.matrix(t[[j]][,start:end]) 
  
nrmse[[j]]<-missForest::nrmse(ximp = xi, xmis = xm, xtrue = xt)

new_list <- setNames((nrmse[j]), placeHolder3)
NRMSE <- append(NRMSE, new_list) 

fullmae[j] <- mean(abs(xt - xi))

new_list2 <- setNames((fullmae[j]), placeHolder3)
fullMAE <- append(fullMAE, new_list2) 

}
 
#partialMAE
 partialmae <- list()  
 partialMAE<-list()
  for(j in 1:length(missForest[["PARTIAL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
    
  xt <- missForest[["PARTIAL"]][[j]][["original"]]
  xi <- missForest[["PARTIAL"]][[j]][["imputed"]]
  
  partialmae[j] <- mean(abs(xt - xi))
  
  new_list <- setNames((partialmae[j]), placeHolder3)
  partialMAE <- append(partialMAE, new_list) 
  }
 
#External check 1 missForest
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.1 <- list()
for(j in 1:length(missForest[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")
  imputedSummary[[j]] <- summary(lm(S_Albumin ~ S_Total_protein, data = missForest[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original - imputed[[j]])/original)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.1 <- append(imputedBias.1, new_list)
}

#External check 2 missForest
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.2 <- list()
for(j in 1:length(missForest[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")
  imputedSummary[[j]] <- summary(lm(S_ALT ~ S_AST, data = missForest[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original2 - imputed[[j]])/original2)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.2 <- append(imputedBias.2, new_list)
}
 
missForest<- append(missForest, list(NRMSE =NRMSE,
                                     partialMAE = partialMAE,
                                     fullMAE = fullMAE ,
                                      imputedBias.1 = imputedBias.1,
                                      imputedBias.2 = imputedBias.2
                                     ))  

res[[k]] <- missForest
}
#nameing

 if((MCAR[1] %in% t[1])){
   missing<-"_MCAR"
 }

if((MAR[1] %in% t[1]) ){
  missing <-"_MAR"
}

if((MNAR[1] %in% t[1]) ){
  missing <-"_MNAR"
}

if(length(impcols) == 1){
   impco<- "_Company"
 }

if(length(impcols) > 1 && !("Toxin" %in% impcols)){
  impco<- "_All"
  }

if(length(impcols) > 1 && "Toxin" %in% impcols){
  impco<- "_All_Toxin"
  }

 if(length(impcols) < 1){
   impco<-"_noMeta"
 }

list_name <- paste("missForest_strata", missing, impco, sep = "")
assign(list_name, res, envir = .GlobalEnv)

n_entries <- length(res)
metrics <- c("NRMSE", "partialMAE", "fullMAE", "imputedBias.1", "imputedBias.2")

# Initialize a list to store the results
results <- list()

# Loop through the metrics
for (metric in metrics) {
  result_matrix <- matrix(NA, nrow = n_entries, ncol = length(res[[1]][[metric]]))
  
  # Loop through the list and extract the current metric values into the matrix
  for (i in 1:n_entries) {
    result_matrix[i, ] <- unlist(res[[i]][[metric]])
  }
  
  # Calculate mean and standard deviation for each column
  mean_values <- apply(result_matrix, 2, mean)
  std_dev_values <- apply(result_matrix, 2, sd)
  
  results[[metric]] <- list(mean = mean_values, std_dev = std_dev_values)
}

list_name <- paste("summary_missForest_strata", missing, impco, sep = "")
assign(list_name, results, envir = .GlobalEnv)

```

###Save
```{r}
save(
       summary_MICErf_MCAR_All,
summary_MICErf_MCAR_All_Toxin,
       summary_MICErf_MCAR_Company,
       summary_MICErf_MCAR_noMeta,
               summary_MICErf_strata_MCAR_All,
               summary_MICErf_strata_MCAR_Company,
       summary_missForest_MCAR_All,
       summary_missForest_MCAR_Company,
       summary_missForest_MCAR_noMeta,
               summary_missForest_strata_MCAR_All,
               summary_missForest_strata_MCAR_Company,
       MICErf_MCAR_All,
MICErf_MCAR_All_Toxin,
       MICErf_MCAR_Company,
       MICErf_MCAR_noMeta,
               MICErf_strata_MCAR_All,
               MICErf_strata_MCAR_Company,
       missForest_MCAR_All,
       missForest_MCAR_Company,
       missForest_MCAR_noMeta,
               missForest_strata_MCAR_All,
               missForest_strata_MCAR_Company,
     file = "MCAR500iteration.Rdata")

```


###missForest without ClinChem
```{r}

#missForest no clinchem
ncmissForest<-list()

FULL<-list()
PARTIAL<-list()
NRMSE<- list()
imputedfull<-list()
imputedonly<-list()
#full<-SCdf[,12:22]
NRMSEncmissForest<-list()

for(j in 1:length(t)){
  placeHolder <- paste0("FULLimputed ", p[j] * 100, " %")
  placeHolder2 <- paste0("imputed vs full ", p[j] * 100, " %")
  
  #identify how many NAs in each collumn
idy<- length((t[[1]][,start]))

#set up empty matrix of the correct size 
matrix_empty = matrix(nrow = idy, ncol = 11)
emptyDF = data.frame(matrix_empty)

imp<- list()

for(i in start:ncol(t[[j]])){
  x<-SCdf[,impcols] 
  
  start2 <- ncol(SCdf[,impcols]) +1
 x[sapply(x, is.character)] <- lapply(x[sapply(x, is.character)], as.factor)
 #x[sapply(x, is.factor)] <- lapply(x[sapply(x, is.factor)], as.numeric)
 
 x <- cbind(x,t[[j]][,i])
  
  #imputation, makes full data frame, but imputation done without clinchem
  imp[[i]] <- missForest::missForest(xmis = x, ntree = 10, variablewise = F)
  emptyDF[,i] <- imp[[i]][["ximp"]][[start2]]
  imputedfull[[j]]<- emptyDF
}
imputedfull[[j]]<- setNames(imputedfull[[j]], cnames)
#locate where NA's were created
idx<-as.data.frame(which(is.na(t[[j]][,start:end]), arr.ind=TRUE))

#create full data frame containing the imputed values and partial data frame that has the original value and the imputed value side by side

idx$imputed<-idx$original<-NA
for(i in 1:nrow(idx)){
  idx$original[i]<-full[idx$row[i],idx$col[i]]
  idx$imputed[i]<-imputedfull[[j]][,start:end][idx$row[i],idx$col[i]]
  imputedonly[[j]]<-idx
}
new_list <- setNames(list(imputedfull[[j]][,start:end]), placeHolder)
FULL <- append(FULL, new_list)  

new_list2 <- setNames(list(imputedonly[[j]]), placeHolder2)
PARTIAL <- append(PARTIAL, new_list2) 

}
  
 ncmissForest<- append(ncmissForest, list(PARTIAL = PARTIAL,
                                          FULL = FULL))
 
#NRMSE + fullMAE
nrmse <-list()
fullmae<-list()
NRMSE<-list()
fullMAE<-list()
for(j in 1:length(ncmissForest[["FULL"]])){
  
placeHolder3 <- paste0( p[,j] * 100, " % missing")  

xi<- as.matrix(ncmissForest[["FULL"]][[j]])
xt<-as.matrix(SCdf[,start:end])
xm<-as.matrix(t[[j]][,start:end]) 
  
nrmse[[j]]<-missForest::nrmse(ximp = xi, xmis = xm, xtrue = xt)

new_list <- setNames((nrmse[j]), placeHolder3)
NRMSE <- append(NRMSE, new_list) 

fullmae[j] <- mean(abs(xt - xi))

new_list2 <- setNames((fullmae[j]), placeHolder3)
fullMAE <- append(fullMAE, new_list2) 

}
 
#partialMAE
 partialmae <- list()  
 partialMAE<-list()
  for(j in 1:length(ncmissForest[["PARTIAL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
    
  xt <- ncmissForest[["PARTIAL"]][[j]][["original"]]
  xi <- ncmissForest[["PARTIAL"]][[j]][["imputed"]]
  
  partialmae[j] <- mean(abs(xt - xi))
  
  new_list <- setNames((partialmae[j]), placeHolder3)
  partialMAE <- append(partialMAE, new_list) 
  }
 
#External check 1 ncmissForest
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.1 <- list()
for(j in 1:length(ncmissForest[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_Albumin ~ S_Total_protein, data = ncmissForest[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original - imputed[[j]])/original)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.1 <- append(imputedBias.1, new_list) 
} 
 
 #External check 2 ncmissForest
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.2 <- list()
for(j in 1:length(ncmissForest[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_ALT ~ S_AST, data = ncmissForest[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original2 - imputed[[j]])/original2)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.2 <- append(imputedBias.2, new_list) 
}
 
ncmissForest<- append(ncmissForest, list(NRMSE = NRMSE,
                                         partialMAE = partialMAE,
                                         fullMAE = fullMAE,
                                         imputedBias.1 = imputedBias.1,
                                         imputedBias.2 = imputedBias.2))  

 
 if((MCAR[1] %in% t[1]) ){
  ncmissForest_MCAR <-ncmissForest
}

if((MAR[1] %in% t[1]) ){
  ncmissForest_MAR <-ncmissForest
}

if((MNAR[1] %in% t[1]) ){
  ncmissForest_MNAR <-ncmissForest
}

```


#METRICS

##External check 1
Albumin and total protein
```{r}
# ggplot(data = SCdf[-1000,], aes(x = S_Total_protein, y = S_Albumin)) +
#   geom_point() +
#    geom_smooth(method = lm,
#                level = 0.95) +
#   stat_poly_eq(data=SCdf[-1000,], aes(x=S_Total_protein, y = S_Albumin))

#set up external checks
original.lm.1 <- summary(lm(S_Albumin ~ S_Total_protein, data = SCdf))
# original.lm.1[["r.squared"]]
original <-original.lm.1[["coefficients"]][2,1]

missed<-list()
missedSummary<-list()
missedBias<-list()
for(j in 1:length(t)){
  missedSummary[[j]] <- summary(lm(S_Albumin ~ S_Total_protein, data = t[[j]], na.action = na.omit))
  missed[[j]] <-missedSummary[[j]][["coefficients"]][2,1]
  missedBias[[j]] <- abs((original - missed[[j]])/original)
}

#External check 1 CALIBER
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.1 <- list()
for(j in 1:length(CALIBER[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_Albumin ~ S_Total_protein, data = CALIBER[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original - imputed[[j]])/original)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.1 <- append(imputedBias.1, new_list) 
}

CALIBER<- append(CALIBER, list(imputedBias.1 = imputedBias.1))  

if((MCAR[1] %in% t[1]) ){
  CALIBER_MCAR <-CALIBER
}

if((MAR[1] %in% t[1]) ){
  CALIBER_MAR <-CALIBER
}

if((MNAR[1] %in% t[1]) ){
  CALIBER_MNAR <-CALIBER
}
 
#External check 1 MICErf
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.1 <- list()
for(j in 1:length(MICErf[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_Albumin ~ S_Total_protein, data = MICErf[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original - imputed[[j]])/original)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.1 <- append(imputedBias.1, new_list) 
}

MICErf<- append(MICErf, list(imputedBias.1 = imputedBias.1))  
if((MCAR[1] %in% t[1]) ){
  MICErf_MCAR <-MICErf
}

if((MAR[1] %in% t[1]) ){
  MICErf_MAR <-MICErf
}

if((MNAR[1] %in% t[1]) ){
  MICErf_MNAR <-MICErf
}

#External check 1 ncMICErf
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.1 <- list()
for(j in 1:length(ncMICErf[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_Albumin ~ S_Total_protein, data = ncMICErf[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original - imputed[[j]])/original)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.1 <- append(imputedBias.1, new_list) 
}

ncMICErf<- append(ncMICErf, list(imputedBias.1 = imputedBias.1))

if((MCAR[1] %in% t[1]) ){
  ncMICErf_MCAR <-ncMICErf
}

if((MAR[1] %in% t[1]) ){
  ncMICErf_MAR <-ncMICErf
}

if((MNAR[1] %in% t[1]) ){
  ncMICErf_MNAR <-ncMICErf
}


#External check 1 missForest
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.1 <- list()
for(j in 1:length(missForest[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_Albumin ~ S_Total_protein, data = missForest[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original - imputed[[j]])/original)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.1 <- append(imputedBias.1, new_list) 
}

missForest<- append(missForest, list(imputedBias.1 = imputedBias.1))  

if((MCAR[1] %in% t[1]) ){
  missForest_MCAR <-missForest
}

if((MAR[1] %in% t[1]) ){
  missForest_MAR <-missForest
}

if((MNAR[1] %in% t[1]) ){
  missForest_MNAR <-missForest
}


#External check 1 ncmissForest
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.1 <- list()
for(j in 1:length(ncmissForest[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_Albumin ~ S_Total_protein, data = ncmissForest[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original - imputed[[j]])/original)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.1 <- append(imputedBias.1, new_list) 
}

ncmissForest<- append(ncmissForest, list(imputedBias.1 = imputedBias.1)) 

if((MCAR[1] %in% t[1]) ){
  ncmissForest_MCAR <-ncmissForest
}

if((MAR[1] %in% t[1]) ){
  ncmissForest_MAR <-ncmissForest
}

if((MNAR[1] %in% t[1]) ){
  ncmissForest_MNAR <-ncmissForest
}
```



##External check 2
AST and ALT
```{r}
# idz<-which(SCdf$S_AST > 2500)
# ggplot(data = SCdf, aes(x = S_ALT, y = S_AST)) +
#   geom_point() +
#   geom_smooth(method = "lm",
#                se=TRUE,
#                level = 0.95) +
#   stat_regline_equation() +
#   stat_poly_eq()

####################
original.lm.2 <- summary(lm(S_ALT ~ S_AST, data = SCdf))
# original.lm.1[["r.squared"]]
original2 <-original.lm.2[["coefficients"]][2,1]

missed2<-list()
missedSummary2<-list()
missedBias2<-list()
for(j in 1:length(t)){
  missedSummary2[[j]] <- summary(lm(S_ALT ~ S_AST, data = t[[j]], na.action = na.omit))
  missed2[[j]] <-missedSummary2[[j]][["coefficients"]][2,1]
  missedBias2[[j]] <- abs((original2 - missed2[[j]])/original2)
}

#CALIBER
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.2 <- list()
for(j in 1:length(CALIBER[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_ALT ~ S_AST, data = CALIBER[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original2 - imputed[[j]])/original2)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.2 <- append(imputedBias.2, new_list) 
}

CALIBER<- append(CALIBER, list(imputedBias.2 = imputedBias.2))  

if((MCAR[1] %in% t[1]) ){
  CALIBER_MCAR <-CALIBER
}

if((MAR[1] %in% t[1]) ){
  CALIBER_MAR <-CALIBER
}

if((MNAR[1] %in% t[1]) ){
  CALIBER_MNAR <-CALIBER
}

#ncMICErf
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.2 <- list()
for(j in 1:length(ncMICErf[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_ALT ~ S_AST, data = ncMICErf[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original2 - imputed[[j]])/original2)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.2 <- append(imputedBias.2, new_list) 
}

ncMICErf<- append(ncMICErf, list(imputedBias.2 = imputedBias.2))  
if((MCAR[1] %in% t[1]) ){
  ncMICErf_MCAR <-ncMICErf
}

if((MAR[1] %in% t[1]) ){
  ncMICErf_MAR <-ncMICErf
}

if((MNAR[1] %in% t[1]) ){
  ncMICErf_MNAR <-ncMICErf
}


#MICErf
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.2 <- list()
for(j in 1:length(MICErf[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_ALT ~ S_AST, data = MICErf[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original2 - imputed[[j]])/original2)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.2 <- append(imputedBias.2, new_list) 
}

MICErf<- append(MICErf, list(imputedBias.2 = imputedBias.2))  

if((MCAR[1] %in% t[1]) ){
  MICErf_MCAR <-MICErf
}

if((MAR[1] %in% t[1]) ){
  MICErf_MAR <-MICErf
}

if((MNAR[1] %in% t[1]) ){
  MICErf_MNAR <-MICErf
}

#External check 2 missForest
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.2 <- list()
for(j in 1:length(missForest[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_ALT ~ S_AST, data = missForest[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original2 - imputed[[j]])/original2)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.2 <- append(imputedBias.2, new_list) 
}

missForest<- append(missForest, list(imputedBias.2 = imputedBias.2))  

if((MCAR[1] %in% t[1]) ){
  missForest_MCAR <-missForest
}

if((MAR[1] %in% t[1]) ){
  missForest_MAR <-missForest
}

if((MNAR[1] %in% t[1]) ){
  missForest_MNAR <-missForest
}


#External check 2 ncmissForest
imputed<-list()
imputedSummary<-list()
imputedBias<-list()
imputedBias.2 <- list()
for(j in 1:length(ncmissForest[["FULL"]])){
  placeHolder3 <- paste0( p[,j] * 100, " % missing")  
  imputedSummary[[j]] <- summary(lm(S_ALT ~ S_AST, data = ncmissForest[["FULL"]][[j]]))
  imputed[[j]] <-imputedSummary[[j]][["coefficients"]][2,1]
  imputedBias[[j]]<- abs((original2 - imputed[[j]])/original2)
  new_list <- setNames((imputedBias[[j]]), placeHolder3)
  imputedBias.2 <- append(imputedBias.2, new_list) 
}

ncmissForest<- append(ncmissForest, list(imputedBias.2 = imputedBias.2)) 

if((MCAR[1] %in% t[1]) ){
  ncmissForest_MCAR <-ncmissForest
}

if((MAR[1] %in% t[1]) ){
  ncmissForest_MAR <-ncmissForest
}

if((MNAR[1] %in% t[1]) ){
  ncmissForest_MNAR <-ncmissForest
}

```

#PCA
```{r}
devtools::install_github("phenological/mva-plots")
library(mva.plots)
functionDir <- "/Users/lucygrigoroff/git/phenological/mva-plots/R/"
functionList <- list.files(path = functionDir)
for(i in functionList){
  source(paste0(functionDir,i))
}

OriginalPCA <-PCA(data = SCdf[,12:22])

OriginalPS<- plotScores(model = OriginalPCA, optns = list(plotTitle = "Original",ellipse = "hotellings", color = SCdf$Company,  outlierLabels = row.names(SCdf)))

OriginalPS[["data"]][["outliers"]][["PC1vPC2"]][["outlierID"]]
idx<-which(rownames(SCdf) %in% OriginalPS[["data"]][["outliers"]][["PC1vPC2"]][["outlierID"]])

#idx<-(25713, 17428, 17433, 17438, 17423, 17443, 27373, 9106, 13762, 13857)

# idx<-which(rownames(SCdf) %in% c("25713", "17428", "17433", "17438", "17423", "17443", "27373", "9106", "13762", "13857"))
# 
# idy<-which(OriginaPCA[["data"]][["PC2"]]< -10)

SCdf2<-SCdf[-idx,]

OriginalPCA <-PCA(data = SCdf2[,12:22])
OriginalPS<- plotScores(model = OriginalPCA, optns = list(plotTitle = "Original",ellipse = "color",color = SCdf2$Company, PCi=1, PCj=2))

#######MAR
CaliberPCA <-PCA(data = CALIBER_MAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
CaliberPS <-plotScores(model = CaliberPCA, optns = list(plotTitle = "CALIBERrfimpute", color = SCdf2$Company,colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))

MICErfPCA <-PCA(data = MICErf_MAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
MICErfPS <-plotScores(model = MICErfPCA, optns = list(plotTitle = "MICErf", color = SCdf2$Company,colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))

ncMICErfPCA <-PCA(data = ncMICErf_MAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
ncMICErfPS <-plotScores(model = ncMICErfPCA, optns = list(plotTitle = "ncMICErf", color = SCdf2$Company,colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))

missForestPCA <-PCA(data = missForest_MAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
missForestPS <-plotScores(model = missForestPCA, optns = list(plotTitle = "missForest", color = SCdf2$Company,colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))

ncmissForestPCA <-PCA(data = ncmissForest_MAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
ncmissForestPS <-plotScores(model = ncmissForestPCA, optns = list(plotTitle = "ncmissForest", color = SCdf2$Company,colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))


PCA_MAR <- ggarrange(plots = list(OriginalPS+ theme(legend.position="none"), CaliberPS+theme(legend.position="none"), MICErfPS, ncMICErfPS+theme(legend.position="none"), missForestPS+theme(legend.position="none"), ncmissForestPS+theme(legend.position="none")), nrow = 2, ncol = 3, common.legend = TRUE, legend = "right", legend.grob = gL)

PCA_MAR_figure <-annotate_figure(PCA_MAR,
                top = text_grob("MAR Scores Plots", face = "bold", size = 14, hjust = 0.5, x = 0.5),
                #bottom = text_grob("2769 Samples", face = "italic", size = 10, hjust = 0.9, x = 0.9),
                #left = text_grob("Bias", rot = 90),
                #fig.lab = "Figure 1", 
                fig.lab.face = "bold")

ggsave(file=paste("MAR PCA outliers removed",nrow(SCdf)," Samples.svg",sep=""), plot=PCA_MAR_figure, width = 10, height = 7)
ggsave(file=paste("MAR PCA outliers removed",nrow(SCdf)," Samples.pdf",sep=""), plot=PCA_MAR_figure, width = 10, height = 7)

###########MCAR
CaliberPCA <-PCA(data = CALIBER_MCAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
CaliberPS <-plotScores(model = CaliberPCA, optns = list(plotTitle = "CALIBERrfimpute", color = SCdf2$Company, colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))

MICErfPCA <-PCA(data = MICErf_MCAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
MICErfPS <-plotScores(model = MICErfPCA, optns = list(plotTitle = "MICErf", color = SCdf2$Company,colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))

ncMICErfPCA <-PCA(data = ncMICErf_MCAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
ncMICErfPS <-plotScores(model = ncMICErfPCA, optns = list(plotTitle = "ncMICErf", color = SCdf2$Company,colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))

missForestPCA <-PCA(data = missForest_MCAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
missForestPS <-plotScores(model = missForestPCA, optns = list(plotTitle = "missForest", color = SCdf2$Company,colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))

ncmissForestPCA <-PCA(data = ncmissForest_MCAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
ncmissForestPS <-plotScores(model = ncmissForestPCA, optns = list(plotTitle = "ncmissForest", color = SCdf2$Company,colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))


PCA_MCAR <- ggarrange(plots = list(OriginalPS+ theme(legend.position="none"), CaliberPS+theme(legend.position="none"), MICErfPS, ncMICErfPS+theme(legend.position="none"), missForestPS+theme(legend.position="none"), ncmissForestPS+theme(legend.position="none")), nrow = 2, ncol = 3, common.legend = TRUE, legend = "right", legend.grob = gL)

PCA_MCAR_figure <-annotate_figure(PCA_MCAR,
                top = text_grob("MCAR Scores Plots", face = "bold", size = 14, hjust = 0.5, x = 0.5),
                #bottom = text_grob("2769 Samples", face = "italic", size = 10, hjust = 0.9, x = 0.9),
                #left = text_grob("Bias", rot = 90),
                #fig.lab = "Figure 1", 
                fig.lab.face = "bold")

ggsave(file=paste("MCAR PCA outliers removed",nrow(SCdf)," Samples.svg",sep=""), plot=PCA_MCAR_figure, width = 10, height = 7)
ggsave(file=paste("MCAR PCA outliers removed",nrow(SCdf)," Samples.pdf",sep=""), plot=PCA_MCAR_figure, width = 10, height = 7)

###########MNAR
CaliberPCA <-PCA(data = CALIBER_MNAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
CaliberPS <-plotScores(model = CaliberPCA, optns = list(plotTitle = "CALIBERrfimpute", color = SCdf2$Company, colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))

MICErfPCA <-PCA(data = MICErf_MNAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
MICErfPS <-plotScores(model = MICErfPCA, optns = list(plotTitle = "MICErf", color = SCdf2$Company,colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))

ncMICErfPCA <-PCA(data = ncMICErf_MNAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
ncMICErfPS <-plotScores(model = ncMICErfPCA, optns = list(plotTitle = "ncMICErf", color = SCdf2$Company,colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))

missForestPCA <-PCA(data = missForest_MNAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
missForestPS <-plotScores(model = missForestPCA, optns = list(plotTitle = "missForest", color = SCdf2$Company,colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))

ncmissForestPCA <-PCA(data = ncmissForest_MNAR[["FULL"]][["FULLimputed 5 %"]][-idx,])
ncmissForestPS <-plotScores(model = ncmissForestPCA, optns = list(plotTitle = "ncmissForest", color = SCdf2$Company,colorTitle = "Company", ellipse = "color", PCi=1, PCj=2))


PCA_MNAR <- ggarrange(plots = list(OriginalPS+ theme(legend.position="none"), CaliberPS+theme(legend.position="none"), MICErfPS, ncMICErfPS+theme(legend.position="none"), missForestPS+theme(legend.position="none"), ncmissForestPS+theme(legend.position="none")), nrow = 2, ncol = 3, common.legend = TRUE, legend = "right", legend.grob = gL)

PCA_MNAR_figure <-annotate_figure(PCA_MNAR,
                top = text_grob("MNAR Scores Plots", face = "bold", size = 14, hjust = 0.5, x = 0.5),
                #bottom = text_grob("2769 Samples", face = "italic", size = 10, hjust = 0.9, x = 0.9),
                #left = text_grob("Bias", rot = 90),
                #fig.lab = "Figure 1", 
                fig.lab.face = "bold")

ggsave(file=paste("MNAR PCA outliers removed",nrow(SCdf)," Samples.svg",sep=""), plot=PCA_MNAR_figure, width = 10, height = 7)
ggsave(file=paste("MNAR PCA outliers removed",nrow(SCdf)," Samples.pdf",sep=""), plot=PCA_MNAR_figure, width = 10, height = 7)
```
#HalfViolin
```{r}


df<-as.data.frame(cbind(SCdf[,"S_Creatinine"],
                        unlist(CALIBER_MAR[["FULL"]][["FULLimputed 5 %"]][["S_Creatinine"]]),
                          unlist(ncMICErf_MAR[["FULL"]][["FULLimputed 5 %"]][["S_Creatinine"]]),
                          unlist(MICErf_MAR[["FULL"]][["FULLimputed 5 %"]][["S_Creatinine"]]),
                          unlist(ncmissForest_MAR[["FULL"]][["FULLimputed 5 %"]][["S_Creatinine"]]),
                          unlist(missForest_MAR[["FULL"]][["FULLimputed 5 %"]][["S_Creatinine"]])))

cn<- c("ncCALIBERrfimpute","ncMICErf","ncmissForest", "MICErf", "missForest")
colnames(df) <-cn

df<-melt(df)

colnames(df)[1] = "Imputation"
df$Missing<- 5

library(tidyverse)
library(ggdist)
 
ggplot(df, aes(x= Imputation, y = value, fill = Imputation)) +
  geom_violinhalf(show.legend = FALSE, trim = T) +
  geom_boxplot(width = .2, alpha = .6, fatten = NULL, show.legend = FALSE) +
  coord_flip() +
  theme()+
  scale_color_manual(values = c("beta" = "black",
                                      "ncCALIBERrfimpute" = "#F8766D",
                                      "ncMICErf"="#A3A500",
                                      "ncmissForest"="#00BF7D",
                                      "MICErf" = "#00B0F6",
                                      "missForest"="#E76BF3" ))

```

```{r}

devtools::install_github("psyteachr/introdataviz")

unit_val<-data.frame(U_Total_volume_collected = "Urine Total Volume Collected (ml)",
                     U_Osmolality  = "Urine Osmolarity(mOsm/l)",
                     U_pH = "Urine pH (pH)",
                     U_Protein = "log Urine Protein (g/L)",
                     U_Glucose = "log Urine Glucose (mmol/L)",
                     S_Creatinine = "log Serum Creatinine (mmol/L)",
                     S_Urea_nitrogen = "log Serum Urea Nitrogen(mmol/L)",
                     S_ALT = "log Serum ALT (IU/L)",
                     S_AST = "log Serum AST(IU/L)",
                     S_Glucose = "Serum Glucose (mmol/L)",
                     S_Sodium = "Serum Sodium (mmol/L)",
                     S_Potassium = "Serum Potassium (mmol/L)",
                     S_Calcium = "Serum Calcium (mmol/L)",
                     S_Phosphorus = "Serum Phosphorus(mmol/L)",
                     S_Albumin = "Serum Albumin (g/L)",
                     S_Total_protein = "Serum Total Protein (g/L)")
do_log<-c("U_Protein","U_Glucose","S_Creatinine","S_Urea_nitrogen","S_ALT","S_AST") # better think of other way

```


A) MAR
```{r,fig.width=8,fig.height=8}

selected_col_names<-c("S_Total_protein","S_Albumin","S_ALT","S_AST")
# selected_method<-c("MAR","MNAR","MCAR")
# MNAR
P<-list()
for(i in selected_col_names){
  y_lab<-unit_val[1,which(colnames(unit_val)==i)]
  tdf<-data.frame(Original = SCdf[[i]],
                Cali_5 = CALIBER_MAR$FULL[[grep("5 %",names(CALIBER_MAR$FULL))]][[i]],
                Cali_40 = CALIBER_MAR$FULL[[grep("40 %",names(CALIBER_MAR$FULL))]][[i]],
                ncMissF_5 = ncmissForest_MAR$FULL[[grep("5 %",names(ncmissForest_MAR$FULL))]][[i]],
                ncMissF_40 = ncmissForest_MAR$FULL[[grep("40 %",names(ncmissForest_MAR$FULL))]][[i]],
                ncMICE_5 = ncMICErf_MAR$FULL[[grep("5 %",names(ncMICErf_MAR$FULL))]][[i]],
                ncMICE_40 = ncMICErf_MAR$FULL[[grep("40 %",names(ncMICErf_MAR$FULL))]][[i]],
                MissF_5 = missForest_MAR$FULL[[grep("5 %",names(missForest_MAR$FULL))]][[i]],
                MissF_40 = missForest_MAR$FULL[[grep("40 %",names(missForest_MAR$FULL))]][[i]],
                MICE_5 = MICErf_MAR$FULL[[grep("5 %",names(MICErf_MAR$FULL))]][[i]],
                MICE_40 = MICErf_MAR$FULL[[grep("40 %",names(MICErf_MAR$FULL))]][[i]]
                )%>%
  pivot_longer(cols = Original:MICE_40,names_to = "Method")%>%
  mutate(value = as.numeric(value),
         `Imputed %` = as.numeric(sapply(strsplit(Method,"_"),"[",2)),
         Method = factor(sapply(strsplit(Method,"_"),"[",1),
                         levels = c("Original","Cali","ncMissF","ncMICE", "MissF","MICE")))%>%
  relocate(`Imputed %`,.after = Method)%>%
  mutate(`Imputed %` = ifelse(is.na(`Imputed %`),100,`Imputed %`))
  
  if(length(grep(i,do_log))==1){
    tdf$value<-log(tdf$value)
  }
  
  
  ggplot(tdf,aes(x = Method, y = value, fill = Method, alpha = factor(`Imputed %`)))+
  introdataviz::geom_split_violin()+
  geom_boxplot(width = .2,outlier.size = -1)+
      stat_summary(fun.data = "mean_se",
               geom = "point",
               size = 1,
               position = position_dodge(0.2))+
    scale_x_discrete(
                   labels = c("Original",
                              "Caliber",
                              "ncMissForrest",
                              "ncMICE",
                              "MissForrest",
                              "MICE"))+
    scale_alpha_manual(name = "Imputed %",values = c(0.3,0.6,1.0))+
    scale_color_manual(values = c("Original"="black",
                                      "Caliber" = "#F8766D",
                                      "ncMICE"="#A3A500",
                                      "ncMissForrest"="#00BF7D",
                                      "MICE" = "#00B0F6",
                                      "MissForrest"="#E76BF3" ))+
    labs(subtitle = y_lab,
         y = "",
         x = "")+
    theme_minimal()+
    theme(legend.position = "bottom")->p1
  P[[i]]<-p1
  rm(tdf,p1,y_lab)

  
}

p_legend<-get_legend(P[[1]])

MAR_violin<- grid.arrange(P[[1]]+theme(legend.position = "n", 
                          axis.text.x = element_blank()),
             P[[2]]+theme(legend.position = "n", 
                          axis.text.x = element_blank()),
             P[[3]]+theme(legend.position = "n", 
                          axis.text.x = element_blank()),
             P[[4]]+theme(legend.position = "n", 
                          axis.text.x = element_blank()),
             p_legend,
             top = "A) MAR",
             heights = c(0.475,0.475,0.05),
  layout_matrix = rbind(c(1, 2),
                        c(3, 4),
                        c(5, 5)))

ggsave(file=paste("MAR Violin",nrow(SCdf)," Samples.svg",sep=""), plot=MAR_violin, width = 10, height = 7)
ggsave(file=paste("MAR Violin",nrow(SCdf)," Samples.pdf",sep=""), plot=MAR_violin, width = 10, height = 7)

```


B) MNAR
```{r,fig.width=8,fig.height=8}

selected_col_names<-c("S_Total_protein","S_Albumin","S_ALT","S_AST")
selected_method<-c("MAR","MNAR","MCAR")
# MNAR
P<-list()
for(i in selected_col_names){
  y_lab<-unit_val[1,which(colnames(unit_val)==i)]
  tdf<-data.frame(Original = SCdf[[i]],
                Cali_5 = CALIBER_MNAR$FULL[[grep("5 %",names(CALIBER_MNAR$FULL))]][[i]],
                Cali_40 = CALIBER_MNAR$FULL[[grep("40 %",names(CALIBER_MNAR$FULL))]][[i]],
                ncMissF_5 = ncmissForest_MNAR$FULL[[grep("5 %",names(ncmissForest_MNAR$FULL))]][[i]],
                ncMissF_40 = ncmissForest_MNAR$FULL[[grep("40 %",names(ncmissForest_MNAR$FULL))]][[i]],
                ncMICE_5 = ncMICErf_MNAR$FULL[[grep("5 %",names(ncMICErf_MNAR$FULL))]][[i]],
                ncMICE_40 = ncMICErf_MNAR$FULL[[grep("40 %",names(ncMICErf_MNAR$FULL))]][[i]],
                MissF_5 = missForest_MNAR$FULL[[grep("5 %",names(missForest_MNAR$FULL))]][[i]],
                MissF_40 = missForest_MNAR$FULL[[grep("40 %",names(missForest_MNAR$FULL))]][[i]],
                MICE_5 = MICErf_MNAR$FULL[[grep("5 %",names(MICErf_MNAR$FULL))]][[i]],
                MICE_40 = MICErf_MNAR$FULL[[grep("40 %",names(MICErf_MNAR$FULL))]][[i]]
                )%>%
  pivot_longer(cols = Original:MICE_40, names_to = "Method") %>%
  mutate(value = as.numeric(value),
         `Imputed %` = as.numeric(sapply(strsplit(Method,"_"),"[",2)),
         Method = factor(sapply(strsplit(Method,"_"),"[",1),
                         levels = c("Original","Cali","ncMissF","ncMICE", "MissF","MICE")))%>%
  relocate(`Imputed %`,.after = Method)%>%
  mutate(`Imputed %` = ifelse(is.na(`Imputed %`),100,`Imputed %`))
  
  if(length(grep(i,do_log))==1){
    tdf$value<-log(tdf$value)
  }
  
  
  ggplot(tdf,aes(x = Method, y = value, fill = Method, alpha = factor(`Imputed %`)))+
  introdataviz::geom_split_violin()+
  geom_boxplot(width = .2,outlier.size = -1)+
      stat_summary(fun.data = "mean_se",
               geom = "point",
               size = 1,
               position = position_dodge(0.2))+
    scale_x_discrete(
                   labels = c("Original",
                              "Caliber",
                              "ncMissForrest",
                              "ncMICE",
                              "MissForrest",
                              "MICE"))+
    scale_alpha_manual(name = "Imputed %",values = c(0.3,0.6,1.0))+
    scale_color_manual(values = c("Original"="black",
                                      "Caliber" = "#F8766D",
                                      "ncMICE"="#A3A500",
                                      "ncMissForrest"="#00BF7D",
                                      "MICE" = "#00B0F6",
                                      "MissForrest"="#E76BF3" ))+
    labs(subtitle = y_lab,
         y = "",
         x = "")+
    theme_minimal()+
    theme(legend.position = "bottom")->p1
  P[[i]]<-p1
  rm(tdf,p1,y_lab)

  
}

p_legend<-get_legend(P[[1]])
# svglite::svglite(filename = "~/OneDrive - Murdoch University/DataStudetns/Janonna/MethodPaper/HalfViolin/MNAR.svg",width = 8,height = 8)
MNAR_violin<-grid.arrange(P[[1]]+theme(legend.position = "n", 
                          axis.text.x = element_blank()),
             P[[2]]+theme(legend.position = "n", 
                          axis.text.x = element_blank()),
             P[[3]]+theme(legend.position = "n", 
                          axis.text.x = element_blank()),
             P[[4]]+theme(legend.position = "n", 
                          axis.text.x = element_blank()),
             p_legend,
             top = "B) MNAR",
             heights = c(0.475,0.475,0.05),
  layout_matrix = rbind(c(1, 2),
                        c(3, 4),
                        c(5, 5)))

# dev.off()

ggsave(file=paste("MNAR Violin",nrow(SCdf)," Samples.svg",sep=""), plot=MNAR_violin, width = 10, height = 7)
ggsave(file=paste("MNAR Violin",nrow(SCdf)," Samples.pdf",sep=""), plot=MNAR_violin, width = 10, height = 7)

```

C) MCAR
```{r,fig.width=8,fig.height=8}

selected_col_names<-c("S_Total_protein","S_Albumin","S_ALT","S_AST")
selected_method<-c("MAR","MNAR","MCAR")
# MNAR
P<-list()
for(i in selected_col_names){
  y_lab<-unit_val[1,which(colnames(unit_val)==i)]
  tdf<-data.frame(Original = SCdf[[i]],
                Cali_5 = CALIBER_MCAR$FULL[[grep("5 %",names(CALIBER_MCAR$FULL))]][[i]],
                Cali_40 = CALIBER_MCAR$FULL[[grep("40 %",names(CALIBER_MCAR$FULL))]][[i]],
                ncMissF_5 = ncmissForest_MCAR$FULL[[grep("5 %",names(ncmissForest_MCAR$FULL))]][[i]],
                ncMissF_40 = ncmissForest_MCAR$FULL[[grep("40 %",names(ncmissForest_MCAR$FULL))]][[i]],
                ncMICE_5 = ncMICErf_MCAR$FULL[[grep("5 %",names(ncMICErf_MCAR$FULL))]][[i]],
                ncMICE_40 = ncMICErf_MCAR$FULL[[grep("40 %",names(ncMICErf_MCAR$FULL))]][[i]],
                MissF_5 = missForest_MCAR$FULL[[grep("5 %",names(missForest_MCAR$FULL))]][[i]],
                MissF_40 = missForest_MCAR$FULL[[grep("40 %",names(missForest_MCAR$FULL))]][[i]],
                MICE_5 = MICErf_MCAR$FULL[[grep("5 %",names(MICErf_MCAR$FULL))]][[i]],
                MICE_40 = MICErf_MCAR$FULL[[grep("40 %",names(MICErf_MCAR$FULL))]][[i]]
                )%>%
  pivot_longer(cols = Original:MICE_40,names_to = "Method")%>%
  mutate(value = as.numeric(value),
         `Imputed %` = as.numeric(sapply(strsplit(Method,"_"),"[",2)),
         Method = factor(sapply(strsplit(Method,"_"),"[",1),
                         levels = c("Original","Cali","ncMissF","ncMICE", "MissF","MICE")))%>%
  relocate(`Imputed %`,.after = Method)%>%
  mutate(`Imputed %` = ifelse(is.na(`Imputed %`),100,`Imputed %`))
  
  if(length(grep(i,do_log))==1){
    tdf$value<-log(tdf$value)
  }
  
  
  ggplot(tdf,aes(x = Method, y = value, fill = Method, alpha = factor(`Imputed %`)))+
  introdataviz::geom_split_violin()+
  geom_boxplot(width = .2,outlier.size = -1)+
      stat_summary(fun.data = "mean_se",
               geom = "point",
               size = 1,
               position = position_dodge(0.2))+
    scale_x_discrete(
                   labels = c("Original",
                              "Caliber",
                              "ncMissForrest",
                              "ncMICE",
                              "MissForrest",
                              "MICE"))+
    scale_alpha_manual(name = "Imputed %",values = c(0.3,0.6,1.0))+
    scale_color_manual(values = c("Original"="black",
                                      "Caliber" = "#F8766D",
                                      "ncMICE"="#A3A500",
                                      "ncMissForrest"="#00BF7D",
                                      "MICE" = "#00B0F6",
                                      "MissForrest"="#E76BF3" ))+
    labs(subtitle = y_lab,
         y = "",
         x = "")+
    theme_minimal()+
    theme(legend.position = "bottom")->p1
  P[[i]]<-p1
  rm(tdf,p1,y_lab)

  
}

p_legend<-get_legend(P[[1]])

MCAR_violin<- grid.arrange(P[[1]]+theme(legend.position = "n", 
                          axis.text.x = element_blank()),
             P[[2]]+theme(legend.position = "n", 
                          axis.text.x = element_blank()),
             P[[3]]+theme(legend.position = "n", 
                          axis.text.x = element_blank()),
             P[[4]]+theme(legend.position = "n", 
                          axis.text.x = element_blank()),
             p_legend,
             top = "C) MCAR",
             heights = c(0.475,0.475,0.05),
  layout_matrix = rbind(c(1, 2),
                        c(3, 4),
                        c(5, 5)))


ggsave(file=paste("MCAR Violin",nrow(SCdf)," Samples.svg",sep=""), plot=MCAR_violin, width = 10, height = 7)
ggsave(file=paste("MCAR Violin",nrow(SCdf)," Samples.pdf",sep=""), plot=MCAR_violin, width = 10, height = 7)

```

#FACET WRAP FIGURES
```{r}
# df<-as.data.frame(cbind(unlist(missedBias),
#                         unlist(CALIBER[["imputedBias.1"]]),
#                           unlist(ncMICErf[["imputedBias.1"]]),
#                           unlist(ncmissForest[["imputedBias.1"]]),
#                           unlist(MICErf[["imputedBias.1"]]),
#                           unlist(missForest[["imputedBias.1"]])))
# 
# cn<- c("incomplete","ncCALIBERrfimpute","ncMICErf","ncmissForest", "MICErf", "missForest")
# colnames(df) <-cn
# 
# df$Missing <- rn
# 
# df$Missing <- factor(df$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))
# 
# df<-melt(df)
# 
# colnames(df)[2] = "Imputation"
# 
# colnames(df)[3] = "Bias"



#NRMSE
nrmse <-list()
NRMSE<-list()

for(j in 1:length(missForest_MNAR[["FULL"]])){
  
placeHolder3 <- paste0( p[,j] * 100, " % missing")  

xi<- as.matrix(missForest_MNAR[["FULL"]][[j]])
xt<-as.matrix(SCdf[,start:end])
xm<-as.matrix(t[[j]][,start:end]) 
  
nrmse[[j]]<-missForest::nrmse(ximp = xi, xmis = xm, xtrue = xt)

new_list <- setNames((nrmse[j]), placeHolder3)
NRMSE <- append(NRMSE, new_list) 

}

missForest_MNAR[["NRMSE"]]<-NRMSE
############################################################################# NRMSE

df<-as.data.frame(cbind(unlist(CALIBER_MCAR[["NRMSE"]]),
                          unlist(ncMICErf_MCAR[["NRMSE"]]),
                          unlist(ncmissForest_MCAR[["NRMSE"]]),
                          unlist(MICErf_MCAR[["NRMSE"]]),
                          unlist(missForest_MCAR[["NRMSE"]])))
df2<-as.data.frame(cbind(unlist(CALIBER_MAR[["NRMSE"]]),
                          unlist(ncMICErf_MAR[["NRMSE"]]),
                          unlist(ncmissForest_MAR[["NRMSE"]]),
                          unlist(MICErf_MAR[["NRMSE"]]),
                          unlist(missForest_MAR[["NRMSE"]])))
df3<-as.data.frame(cbind(unlist(CALIBER_MNAR[["NRMSE"]]),
                          unlist(ncMICErf_MNAR[["NRMSE"]]),
                          unlist(ncmissForest_MNAR[["NRMSE"]]),
                          unlist(MICErf_MNAR[["NRMSE"]]),
                          unlist(missForest_MNAR[["NRMSE"]])))

# df2<-as.data.frame(cbind(unlist(CALIBER_MAR[["partialMAE"]]),
#                           unlist(ncMICErf_MAR[["partialMAE"]]),
#                           unlist(ncmissForest_MAR[["partialMAE"]]),
#                           unlist(MICErf_MAR[["partialMAE"]]),
#                           unlist(missForest_MAR[["partialMAE"]])))
# df3<-as.data.frame(cbind(unlist(CALIBER_MNAR[["fullMAE"]]),
#                           unlist(ncMICErf_MNAR[["fullMAE"]]),
#                           unlist(ncmissForest_MNAR[["fullMAE"]]),
#                           unlist(MICErf_MNAR[["fullMAE"]]),
#                           unlist(missForest_MNAR[["fullMAE"]])))

cn<- c("ncCALIBERrfimpute","ncMICErf","ncmissForest", "MICErf", "missForest")
colnames(df) <-cn
colnames(df2) <-cn
colnames(df3) <-cn

df$Missing<-rn
df2$Missing<-rn
df3$Missing<-rn
df$Missing <- factor(df$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))
df2$Missing <- factor(df2$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))
df3$Missing <- factor(df3$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))

df<-melt(df)
df2<-melt(df2)
df3<-melt(df3)

colnames(df)[2] = "Imputation"
colnames(df2)[2] = "Imputation"
colnames(df3)[2] = "Imputation"

colnames(df)[3] = "NRMSE MCAR"
colnames(df2)[3] = "NRMSE MAR"
colnames(df3)[3] = "NRMSE MNAR"

df4<- cbind(df, df2[,"NRMSE MAR"], df3[,"NRMSE MNAR"])
colnames(df4)<- c("Missing","Imputation","MCAR","MAR","MNAR")
NRMSEdf5<- melt(df4)

sampleNo<- paste(nrow(SCdf), "Total Samples")

facetedNRMSE<- ggplot(data = NRMSEdf5, aes(x= `Missing`, y = `value`, colour = Imputation)) +
                geom_point() +
                geom_line(aes(group = Imputation)) +
                labs(y = "NRMSE",
                     colour = "Imputation",
                     title = "Normalised Root Mean Square Error") +
                theme_bw() + 
                theme(strip.background =element_rect(fill="White"))+
                theme(strip.text = element_text(colour = "Black"))+
                scm +
                facet_wrap(~ variable) + 
                labs(caption = sampleNo)

ggsave(file=paste("NRMSE ",nrow(SCdf)," Samples.svg",sep=""), plot=facetedNRMSE, width = 10, height = 3)
ggsave(file=paste("NRMSE ",nrow(SCdf)," Samples.pdf",sep=""), plot=facetedNRMSE, width = 10, height = 7)
############################################################################# fullMAE

df<-as.data.frame(cbind(unlist(CALIBER_MCAR[["fullMAE"]]),
                          unlist(ncMICErf_MCAR[["fullMAE"]]),
                          unlist(ncmissForest_MCAR[["fullMAE"]]),
                          unlist(MICErf_MCAR[["fullMAE"]]),
                          unlist(missForest_MCAR[["fullMAE"]])))
df2<-as.data.frame(cbind(unlist(CALIBER_MAR[["fullMAE"]]),
                          unlist(ncMICErf_MAR[["fullMAE"]]),
                          unlist(ncmissForest_MAR[["fullMAE"]]),
                          unlist(MICErf_MAR[["fullMAE"]]),
                          unlist(missForest_MAR[["fullMAE"]])))
df3<-as.data.frame(cbind(unlist(CALIBER_MNAR[["fullMAE"]]),
                          unlist(ncMICErf_MNAR[["fullMAE"]]),
                          unlist(ncmissForest_MNAR[["fullMAE"]]),
                          unlist(MICErf_MNAR[["fullMAE"]]),
                          unlist(missForest_MNAR[["fullMAE"]])))

cn<- c("ncCALIBERrfimpute","ncMICErf","ncmissForest", "MICErf", "missForest")
colnames(df) <-cn
colnames(df2) <-cn
colnames(df3) <-cn

df$Missing<-rn
df2$Missing<-rn
df3$Missing<-rn
df$Missing <- factor(df$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))
df2$Missing <- factor(df2$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))
df3$Missing <- factor(df3$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))

df<-melt(df)
df2<-melt(df2)
df3<-melt(df3)

colnames(df)[2] = "Imputation"
colnames(df2)[2] = "Imputation"
colnames(df3)[2] = "Imputation"

colnames(df)[3] = "fullMAE MCAR"
colnames(df2)[3] = "fullMAE MAR"
colnames(df3)[3] = "fullMAE MNAR"

df4<- cbind(df, df2[,"fullMAE MAR"], df3[,"fullMAE MNAR"])
colnames(df4)<- c("Missing","Imputation","MCAR","MAR","MNAR")
fullMAEdf5<- melt(df4)

sampleNo<- paste(nrow(SCdf), "Total Samples")

facetedfullMAE<- ggplot(data = fullMAEdf5, aes(x= `Missing`, y = `value`, colour = Imputation)) +
                geom_point() +
                geom_line(aes(group = Imputation)) +
                labs(y = "fullMAE",
                     colour = "Imputation",
                     title = "Full Mean Absolute Error") +
                theme_bw() + 
                theme(strip.background =element_rect(fill="White"))+
                theme(strip.text = element_text(colour = "Black"))+
                scm +
                facet_wrap(~ variable) + 
                labs(caption = sampleNo)

ggsave(file=paste("fullMAE ",nrow(SCdf)," Samples.svg",sep=""), plot=facetedfullMAE, width = 10, height = 7)
ggsave(file=paste("fullMAE ",nrow(SCdf)," Samples.pdf",sep=""), plot=facetedfullMAE, width = 10, height = 7)

############################################################################# partialMAE

df<-as.data.frame(cbind(unlist(CALIBER_MCAR[["partialMAE"]]),
                          unlist(ncMICErf_MCAR[["partialMAE"]]),
                          unlist(ncmissForest_MCAR[["partialMAE"]]),
                          unlist(MICErf_MCAR[["partialMAE"]]),
                          unlist(missForest_MCAR[["partialMAE"]])))
df2<-as.data.frame(cbind(unlist(CALIBER_MAR[["partialMAE"]]),
                          unlist(ncMICErf_MAR[["partialMAE"]]),
                          unlist(ncmissForest_MAR[["partialMAE"]]),
                          unlist(MICErf_MAR[["partialMAE"]]),
                          unlist(missForest_MAR[["partialMAE"]])))
df3<-as.data.frame(cbind(unlist(CALIBER_MNAR[["partialMAE"]]),
                          unlist(ncMICErf_MNAR[["partialMAE"]]),
                          unlist(ncmissForest_MNAR[["partialMAE"]]),
                          unlist(MICErf_MNAR[["partialMAE"]]),
                          unlist(missForest_MNAR[["partialMAE"]])))

cn<- c("ncCALIBERrfimpute","ncMICErf","ncmissForest", "MICErf", "missForest")
colnames(df) <-cn
colnames(df2) <-cn
colnames(df3) <-cn

df$Missing<-rn
df2$Missing<-rn
df3$Missing<-rn
df$Missing <- factor(df$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))
df2$Missing <- factor(df2$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))
df3$Missing <- factor(df3$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))

df<-melt(df)
df2<-melt(df2)
df3<-melt(df3)

colnames(df)[2] = "Imputation"
colnames(df2)[2] = "Imputation"
colnames(df3)[2] = "Imputation"

colnames(df)[3] = "partialMAE MCAR"
colnames(df2)[3] = "partialMAE MAR"
colnames(df3)[3] = "partialMAE MNAR"

df4<- cbind(df, df2[,"partialMAE MAR"], df3[,"partialMAE MNAR"])
colnames(df4)<- c("Missing","Imputation","MCAR","MAR","MNAR")
partialMAEdf5<- melt(df4)

sampleNo<- paste(nrow(SCdf), "Total Samples")

facetedpartialMAE<- ggplot(data = partialMAEdf5, aes(x= `Missing`, y = `value`, colour = Imputation)) +
                geom_point() +
                geom_line(aes(group = Imputation)) +
                labs(y = "partialMAE",
                     colour = "Imputation",
                     title = "Partial Mean Absolute Error") +
                theme_bw() + 
                theme(strip.background =element_rect(fill="White"))+
                theme(strip.text = element_text(colour = "Black"))+
                scm +
                facet_wrap(~ variable) + 
                labs(caption = sampleNo)

ggsave(file=paste("partialMAE ",nrow(SCdf)," Samples.svg",sep=""), plot=facetedpartialMAE, width = 10, height = 7)
ggsave(file=paste("partialMAE ",nrow(SCdf)," Samples.pdf",sep=""), plot=facetedpartialMAE, width = 10, height = 7)
############################################################################# imputedBias.1

df<-as.data.frame(cbind(unlist(missedBias),
                          unlist(CALIBER_MCAR[["imputedBias.1"]]),
                          unlist(ncMICErf_MCAR[["imputedBias.1"]]),
                          unlist(ncmissForest_MCAR[["imputedBias.1"]]),
                          unlist(MICErf_MCAR[["imputedBias.1"]]),
                          unlist(missForest_MCAR[["imputedBias.1"]])))
df2<-as.data.frame(cbind(unlist(missedBias),
                         unlist(CALIBER_MAR[["imputedBias.1"]]),
                          unlist(ncMICErf_MAR[["imputedBias.1"]]),
                          unlist(ncmissForest_MAR[["imputedBias.1"]]),
                          unlist(MICErf_MAR[["imputedBias.1"]]),
                          unlist(missForest_MAR[["imputedBias.1"]])))
df3<-as.data.frame(cbind(unlist(missedBias),
                          unlist(CALIBER_MNAR[["imputedBias.1"]]),
                          unlist(ncMICErf_MNAR[["imputedBias.1"]]),
                          unlist(ncmissForest_MNAR[["imputedBias.1"]]),
                          unlist(MICErf_MNAR[["imputedBias.1"]]),
                          unlist(missForest_MNAR[["imputedBias.1"]])))

cn<- c("incomplete","ncCALIBERrfimpute","ncMICErf","ncmissForest", "MICErf", "missForest")
colnames(df) <-cn
colnames(df2) <-cn
colnames(df3) <-cn

df$Missing<-rn
df2$Missing<-rn
df3$Missing<-rn
df$Missing <- factor(df$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))
df2$Missing <- factor(df2$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))
df3$Missing <- factor(df3$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))

df<-melt(df)
df2<-melt(df2)
df3<-melt(df3)

colnames(df)[2] = "Imputation"
colnames(df2)[2] = "Imputation"
colnames(df3)[2] = "Imputation"

colnames(df)[3] = "imputedBias.1 MCAR"
colnames(df2)[3] = "imputedBias.1 MAR"
colnames(df3)[3] = "imputedBias.1 MNAR"

df4<- cbind(df, df2[,"imputedBias.1 MAR"], df3[,"imputedBias.1 MNAR"])
colnames(df4)<- c("Missing","Imputation","MCAR","MAR","MNAR")
imputedBias.1df5<- melt(df4)

sampleNo<- paste(nrow(SCdf), "Total Samples")

facetedimputedBias.1<- ggplot(data = imputedBias.1df5, aes(x= `Missing`, y = `value`, colour = Imputation)) +
                geom_point() +
                geom_line(aes(group = Imputation)) +
                labs(y = "Bias",
                     colour = "Imputation",
                     title = "Albumin to Total Protein Bias") +
                theme_bw() + 
                theme(strip.background =element_rect(fill="White"))+
                theme(strip.text = element_text(colour = "Black"))+
                scm +
                facet_wrap(~ variable) + 
                labs(caption = sampleNo)

ggsave(file=paste("imputedBias.1 ",nrow(SCdf)," Samples.svg",sep=""), plot=facetedimputedBias.1, width = 10, height = 7)
ggsave(file=paste("imputedBias.1 ",nrow(SCdf)," Samples.pdf",sep=""), plot=facetedimputedBias.1, width = 10, height = 7)
############################################################################# imputedBias.2

df<-as.data.frame(cbind(unlist(missedBias),
                        unlist(CALIBER_MCAR[["imputedBias.2"]]),
                          unlist(ncMICErf_MCAR[["imputedBias.2"]]),
                          unlist(ncmissForest_MCAR[["imputedBias.2"]]),
                          unlist(MICErf_MCAR[["imputedBias.2"]]),
                          unlist(missForest_MCAR[["imputedBias.2"]])
                        ))
df2<-as.data.frame(cbind(unlist(missedBias),
                         unlist(CALIBER_MAR[["imputedBias.2"]]),
                          unlist(ncMICErf_MAR[["imputedBias.2"]]),
                          unlist(ncmissForest_MAR[["imputedBias.2"]]),
                          unlist(MICErf_MAR[["imputedBias.2"]]),
                          unlist(missForest_MAR[["imputedBias.2"]])
                         ))
df3<-as.data.frame(cbind(unlist(missedBias),
                         unlist(CALIBER_MNAR[["imputedBias.2"]]),
                          unlist(ncMICErf_MNAR[["imputedBias.2"]]),
                          unlist(ncmissForest_MNAR[["imputedBias.2"]]),
                          unlist(MICErf_MNAR[["imputedBias.2"]]),
                          unlist(missForest_MNAR[["imputedBias.2"]])
                         ))

cn<- c("incomplete","ncCALIBERrfimpute","ncMICErf","ncmissForest", "MICErf", "missForest")
colnames(df) <-cn
colnames(df2) <-cn
colnames(df3) <-cn

df$Missing<-rn
df2$Missing<-rn
df3$Missing<-rn
df$Missing <- factor(df$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))
df2$Missing <- factor(df2$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))
df3$Missing <- factor(df3$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))

df<-melt(df)
df2<-melt(df2)
df3<-melt(df3)

colnames(df)[2] = "Imputation"
colnames(df2)[2] = "Imputation"
colnames(df3)[2] = "Imputation"

colnames(df)[3] = "imputedBias.2 MCAR"
colnames(df2)[3] = "imputedBias.2 MAR"
colnames(df3)[3] = "imputedBias.2 MNAR"

df4<- cbind(df, df2[,"imputedBias.2 MAR"], df3[,"imputedBias.2 MNAR"])
colnames(df4)<- c("Missing","Imputation","MCAR","MAR","MNAR")
imputedBias.2df5<- melt(df4)

sampleNo<- paste(nrow(SCdf), "Total Samples")

facetedimputedBias.2<- ggplot(data = imputedBias.2df5, aes(x= `Missing`, y = `value`, colour = Imputation), alpha = 0.4) +
                geom_point() +
                geom_line(aes(group = Imputation)) +
                labs(y = "Bias",
                     colour = "Imputation",
                     title = "AST to ALT Bias") +
                theme_bw() + 
                theme(strip.background =element_rect(fill="White"))+
                theme(strip.text = element_text(colour = "Black"))+
                scm +
                facet_wrap(~ variable) + 
                labs(caption = sampleNo)

ggsave(file=paste("imputedBias.2 ",nrow(SCdf)," Samples.svg",sep=""), plot=facetedimputedBias.2, width = 10, height = 7)
ggsave(file=paste("imputedBias.2 ",nrow(SCdf)," Samples.pdf",sep=""), plot=facetedimputedBias.2, width = 10, height = 7)
```

```{r}
fullMAEdf5_50<-fullMAEdf5
partialMAEdf5_50 <-partialMAEdf5
NRMSEdf5_50 <- NRMSEdf5
imputedBias.1df5_50 <- imputedBias.1df5
imputedBias.2df5_50 <- imputedBias.2df5

save(MAR, MCAR, MNAR, CALIBER_MAR,CALIBER_MCAR,CALIBER_MNAR ,ncMICErf_MAR,ncMICErf_MCAR,ncMICErf_MNAR, MICErf_MAR, MICErf_MCAR, MICErf_MNAR,ncmissForest_MAR,ncmissForest_MCAR,ncmissForest_MNAR, missForest_MAR,missForest_MCAR,missForest_MNAR,  file = "data50.RData")
```

```{r}
fullMAEdf5_50$sampleN<- 50
partialMAEdf5_50$sampleN <- 50
NRMSEdf5_50$sampleN <- 50
imputedBias.1df5_50$sampleN <- 50
imputedBias.2df5_50$sampleN <- 50

fullMAEdf5_500$sampleN<- 500
partialMAEdf5_500$sampleN <- 500
NRMSEdf5_500$sampleN <- 500
imputedBias.1df5_500$sampleN <- 500
imputedBias.2df5_500$sampleN <- 500

fullMAEdf5_2769$sampleN<- 2769
partialMAEdf5_2769$sampleN <- 2769
NRMSEdf5_2769$sampleN <- 2769
imputedBias.1df5_2769$sampleN <- 2769
imputedBias.2df5_2769$sampleN <- 2769

####NRMSE

tttt<- rbind(NRMSEdf5_50,NRMSEdf5_500,NRMSEdf5_2769)
NRMSE_MCAR_plot <- ggplot(data = subset(tttt, variable %in% c("MCAR")), aes(x= `Missing`, y = `value`, colour = Imputation), alpha = 0.4) +
                geom_point() +
                geom_line(aes(group = Imputation)) +
                labs(y = "NRMSE",
                     colour = "Imputation",
                     title = "NRMSE MCAR") +
                theme_bw() + 
                theme(strip.background =element_rect(fill="White"))+
                theme(strip.text = element_text(colour = "Black"))+
                scm +
                facet_wrap(~ sampleN) 

####partialMAE


tttt<- rbind(imputedBias.2df5_50, imputedBias.2df5_500 ,imputedBias.2df5_2769)
bias2_MAR_plot <- ggplot(data = subset(tttt, variable %in% c("MAR")), aes(x= `Missing`, y = `value`, colour = Imputation), alpha = 0.4) +
                geom_point() +
                geom_line(aes(group = Imputation)) +
                labs(y = "Bias",
                     colour = "Imputation",
                     title = "AST & ALT MAR") +
                theme_bw() + 
                theme(strip.background =element_rect(fill="White"))+
                theme(strip.text = element_text(colour = "Black"))+
                scm +
                facet_wrap(~ sampleN) 

ggsave(file="Bias 2 MNAR.svg", plot = bias2_MNAR_plot, width = 10, height = 7)
ggsave(file="Bias 2 MNAR.pdf", plot = bias2_MNAR_plot, width = 10, height = 7)
```
#FIGURES
##FIGURES for NRMSE, partialMAE and fullMAE
##NRMSE + MAE
```{r}
df<-as.data.frame(cbind(unlist(CALIBER[["NRMSE"]]),
                          unlist(ncMICErf[["NRMSE"]]),
                          unlist(ncmissForest[["NRMSE"]]),
                          unlist(MICErf[["NRMSE"]]),
                          unlist(missForest[["NRMSE"]])))
df2<-as.data.frame(cbind(unlist(CALIBER[["partialMAE"]]),
                          unlist(ncMICErf[["partialMAE"]]),
                          unlist(ncmissForest[["partialMAE"]]),
                          unlist(MICErf[["partialMAE"]]),
                          unlist(missForest[["partialMAE"]])))
df3<-as.data.frame(cbind(unlist(CALIBER[["fullMAE"]]),
                          unlist(ncMICErf[["fullMAE"]]),
                          unlist(ncmissForest[["fullMAE"]]),
                          unlist(MICErf[["fullMAE"]]),
                          unlist(missForest[["fullMAE"]])))

cn<- c("ncCALIBERrfimpute","ncMICErf","ncmissForest", "MICErf", "missForest")
colnames(df) <-cn
colnames(df2) <-cn
colnames(df3) <-cn

df$Missing<-rn
df2$Missing<-rn
df3$Missing<-rn
df$Missing <- factor(df$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))
df2$Missing <- factor(df2$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))
df3$Missing <- factor(df3$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))

df<-melt(df)
df2<-melt(df2)
df3<-melt(df3)

colnames(df)[2] = "Imputation"
colnames(df2)[2] = "Imputation"
colnames(df3)[2] = "Imputation"

colnames(df)[3] = "NRMSE"
colnames(df2)[3] = "partialMAE"
colnames(df3)[3] = "fullMAE"

df4<- cbind(df, df2[,"partialMAE"], df3[,"fullMAE"])
colnames(df4)<- c("Missing","Imputation","NRMSE","partialMAE","fullMAE")

if((MCAR[1] %in% t[1]) ){
  plottitle <- "MCAR" 
  
}

if((MAR[1] %in% t[1]) ){
plottitle <-"MAR"
  
}

if((MNAR[1] %in% t[1]) ){
  plottitle <-"MNAR"
  
}

plot1 <- ggplot(data = df4, aes(x= `Missing`, y = `NRMSE`, colour = Imputation)) +
          geom_point() +
          geom_line(aes(group = Imputation)) +
          labs(y = "NRMSE",
               colour = "Imputation",
               title = plottitle) +
          theme_bw() + scm

plot2 <- ggplot(data = df4, aes(x = `Missing`, y = `partialMAE`, colour = Imputation)) +
          geom_point() +
          geom_line(aes(group = Imputation)) +
          labs(y = "partialMAE",
               colour = "Imputation",
               title = plottitle) +
          theme_bw() +
          scm

plot3 <- ggplot(data = df4, aes(x= `Missing`, y = `fullMAE`, colour = Imputation)) +
          geom_point() +
          geom_line(aes(group = Imputation)) +
          labs(y = "fullMAE",
               colour = "Imputation",
               title = plottitle) +
          theme_bw() +
          scm

if((MCAR[1] %in% t[1]) ){
  NRMSE_MCAR <- plot1
  partialMAE_MCAR<- plot2
  fullMAE_MCAR<- plot3
}

if((MAR[1] %in% t[1]) ){
  NRMSE_MAR <-plot1
  partialMAE_MAR<- plot2
  fullMAE_MAR<- plot3
}

if((MNAR[1] %in% t[1]) ){
  NRMSE_MNAR <-plot1
  partialMAE_MNAR<- plot2
  fullMAE_MNAR<- plot3
}

```

```{r}

df<-as.data.frame(cbind(unlist(missedBias),
                        unlist(CALIBER[["imputedBias.2"]]),
                          unlist(ncMICErf[["imputedBias.2"]]),
                          unlist(ncmissForest[["imputedBias.2"]]),
                          unlist(MICErf[["imputedBias.2"]]),
                          unlist(missForest[["imputedBias.2"]])))

cn<- c("incomplete","ncCALIBERrfimpute","ncMICErf","ncmissForest", "MICErf", "missForest")
colnames(df) <-cn

df$Missing <- rn
#df$Missing<-rownames(df)

df$Missing <- factor(df$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))

df<-melt(df)

colnames(df)[2] = "Imputation"

colnames(df)[3] = "Bias"

plot1 <- ggplot(data = df, aes(x= `Missing`, y = `Bias`, colour = Imputation)) +
          geom_point() +
          geom_line(aes(group = Imputation)) +
          labs(y = "Bias",
               colour = "Imputation",
               title = plottitle) +
          theme_bw()+
          scm


if((MCAR[1] %in% t[1]) ){
  externalBias.2_MCAR <- plot1
}

if((MAR[1] %in% t[1]) ){
  externalBias.2_MAR <-plot1
}

if((MNAR[1] %in% t[1]) ){
  externalBias.2_MNAR <-plot1
}

```
```{r}

library(ggpubr)
fmae<-ggpubr::ggarrange(fullMAE_MCAR,
                        fullMAE_MAR,
                        fullMAE_MNAR, ncol = 3, nrow = 1, common.legend = TRUE, legend="right")

fullMAEfigure <- ggpubr::annotate_figure(fmae, top = text_grob("full Mean Absolute Error", 
               color = "black", face = "bold", size = 14))


pmae<-ggpubr::ggarrange(partialMAE_MCAR,
                        partialMAE_MAR,
                        partialMAE_MNAR, ncol = 3, nrow = 1, common.legend = TRUE, legend="right")

partialMAEfigure <-ggpubr::annotate_figure(pmae, top = text_grob("partial Mean Absolute Error", 
               color = "black", face = "bold", size = 14))

nrmsef<-ggpubr::ggarrange(NRMSE_MCAR,
                          NRMSE_MAR,
                          NRMSE_MNAR, ncol = 3, nrow = 1, common.legend = TRUE, legend="right")

NRMSEfigure <-ggpubr::annotate_figure(nrmsef, top = text_grob("Normalised Root Mean Square Error", 
               color = "black", face = "bold", size = 14))


externalBias.1<-ggpubr::ggarrange(externalBias.1_MCAR,
                                        externalBias.1_MAR,
                                        externalBias.1_MNAR, ncol = 3, nrow = 1, common.legend = TRUE, legend="right")

externalBias.1figure <-ggpubr::annotate_figure(externalBias.1, top = text_grob("External Bias for Albumin and Total Protein", 
               color = "black", face = "bold", size = 14))

externalBias.2<-ggpubr::ggarrange(externalBias.2_MCAR + theme(axis.title.y = element_blank()),
                                        externalBias.2_MAR+ theme(axis.title.y = element_blank()),
                                        externalBias.2_MNAR+ theme(axis.title.y = element_blank()), ncol = 3, nrow = 1, common.legend = TRUE, legend="right", labels = c("(a)", "(b)", "(c)"))

# externalBias.2figure <-ggpubr::annotate_figure(externalBias.2, top = text_grob("External Bias for AST and ALT (n 2769)", 
#                color = "black", face = "bold", size = 14))

externalBias.2figure <-annotate_figure(externalBias.2,
                top = text_grob("External Bias for AST and ALT", face = "bold", size = 14),
                bottom = text_grob("2769 Samples", face = "italic", size = 10),
                left = text_grob("Bias", rot = 90),
                #fig.lab = "Figure 1", 
                fig.lab.face = "bold")


externalBias.2_MCAR+ theme(axis.title.y = element_blank())
```
##Figure External Bias 2
```{r}
externalBias.2 <-
ggarrange(tag_facet(externalBias.2_MCAR + 
                     theme(axis.ticks.y = element_blank(),
                           legend.position="none") +
                     facet_wrap(~"Missing"),
                     tag_pool = "a"), 
          tag_facet(externalBias.2_MAR + 
                          theme(axis.text.y = element_blank(),
                                axis.ticks.y = element_blank(),
                                axis.title.y = element_blank(),
                                legend.position="none") +
                          facet_wrap(~"Missing"), 
                    tag_pool = "b" ), 
          tag_facet(externalBias.2_MNAR + 
                          theme(axis.text.y = element_blank(),
                                axis.ticks.y = element_blank(),
                                axis.title.y = element_blank()) +
                          facet_wrap(~"Missing"),
                     tag_pool = "c"),
          nrow = 1)

externalBias.2figure <-annotate_figure(externalBias.2,
                top = text_grob("External Bias for AST and ALT", face = "bold", size = 14, hjust = 0.35, x = 0.35),
                bottom = text_grob("2769 Samples", face = "italic", size = 10, hjust = 0.9, x = 0.9),
                #left = text_grob("Bias", rot = 90),
                #fig.lab = "Figure 1", 
                fig.lab.face = "bold")

ggsave(file="AST ALT Bias 2769 Samples.svg", plot=externalBias.2figure, width = 10, height = 7)
ggsave(file="AST ALT Bias 2769 Samples.pdf", plot=externalBias.2figure, width = 10, height = 7)
```
##External Bias 1 Figure 
```{r}
externalBias.1 <-
ggarrange(tag_facet(externalBias.1_MCAR + 
                     theme(axis.ticks.y = element_blank(),
                           legend.position="none") +
                     facet_wrap(~"Missing"),
                     tag_pool = "a"), 
          tag_facet(externalBias.1_MAR + 
                          theme(axis.text.y = element_blank(),
                                axis.ticks.y = element_blank(),
                                axis.title.y = element_blank(),
                                legend.position="none") +
                          facet_wrap(~"Missing"), 
                    tag_pool = "b" ), 
          tag_facet(externalBias.1_MNAR + 
                          theme(axis.text.y = element_blank(),
                                axis.ticks.y = element_blank(),
                                axis.title.y = element_blank()) +
                          facet_wrap(~"Missing"),
                     tag_pool = "c"),
          nrow = 1)

externalBias.1figure <-annotate_figure(externalBias.1,
                top = text_grob("External Bias for Albumin and Total Protein", face = "bold", size = 14, hjust = 0.35, x = 0.35),
                bottom = text_grob("2769 Samples", face = "italic", size = 10, hjust = 0.9, x = 0.9),
                #left = text_grob("Bias", rot = 90),
                #fig.lab = "Figure 1", 
                fig.lab.face = "bold")

ggsave(file="Albumin Total Protein Bias 2769 Samples.svg", plot=externalBias.1figure, width = 10, height = 7)
ggsave(file="Albumin Total Protein Bias 2769 Samples.pdf", plot=externalBias.1figure, width = 10, height = 7)
```
##External Bias 1 facet wrap
```{r}
df<-as.data.frame(cbind(unlist(missedBias),
                        unlist(CALIBER[["imputedBias.2"]]),
                          unlist(ncMICErf[["imputedBias.2"]]),
                          unlist(ncmissForest[["imputedBias.2"]]),
                          unlist(MICErf[["imputedBias.2"]]),
                          unlist(missForest[["imputedBias.2"]])))

cn<- c("incomplete","ncCALIBERrfimpute","ncMICErf","ncmissForest", "MICErf", "missForest")
colnames(df) <-cn

df$Missing <- rn
#df$Missing<-rownames(df)

df$Missing <- factor(df$Missing, levels = c("5 %","10 %","20 %","30 %","40 %"))

df<-melt(df)

colnames(df)[2] = "Imputation"

colnames(df)[3] = "Bias"
```



#External check
```{r}
#find relationship to test bias. Serum Albumin and Total Protein have a strong relationship. 
#df2 <- df[rowSums(is.na(df[,15:30])) > 0, ]  
firstcol = which(colnames(SCdf)=="S_Creatinine")
lastcol = which(colnames(SCdf)=="S_Total_protein")

pairs(SCdf[c(firstcol:lastcol)])

ggplot(data = SCdf, aes(x = S_Total_protein, y = S_Albumin)) +
  geom_point() +
   geom_smooth(method = lm,
               level = 0.95) +
  stat_poly_eq(data=SCdf, aes(x=S_Total_protein, y = S_Albumin)) +
  theme_bw() +
  labs(title = "Serum Albumin and Total Protein", subtitle = "Original 2769 samples") +
  xlab("Total Protein (g/L)") +
  ylab("Albumin (g/L)")
  

ggplot(data = SCdf, aes(x = S_ALT, y = S_AST)) +
  geom_point() +
 geom_smooth(method = lm,
               level = 0.95) +
  stat_poly_eq(data=SCdf, aes(x=S_ALT, y = S_AST))+
  theme_bw() +
  labs(title = "AST and ALT", subtitle = "Original 2769 samples") +
  xlab("AST (IU/L)") +
  ylab("ALT (IU/L)")


ggpubr::stat_cor(method = "pearson",
                   hjust = 0,
                   vjust = 0) 


x <- 1:100
y <- (x + x^2 + x^3) + rnorm(length(x), mean = 0, sd = mean(x^3) / 4)
my.data <- data.frame(x, y, group = c("A", "B"),
                      y2 = y * c(0.5,2), block = c("a", "a", "b", "b"))


my.data.Albumin <- cbind(SCdf$S_Albumin,
                         CALIBER_MAR[["FULL"]][["FULLimputed 40 %"]][["S_Albumin"]],
                         MICErf_MAR[["FULL"]][["FULLimputed 40 %"]][["S_Albumin"]], 
                         ncMICErf_MAR[["FULL"]][["FULLimputed 40 %"]][["S_Albumin"]], 
                         missForest_MAR[["FULL"]][["FULLimputed 40 %"]][["S_Albumin"]],
                         ncmissForest_MAR[["FULL"]][["FULLimputed 40 %"]][["S_Albumin"]])

my.data.TotalProtein <- cbind(SCdf$S_Total_protein,
                         CALIBER_MAR[["FULL"]][["FULLimputed 40 %"]][["S_Total_protein"]],
                         MICErf_MAR[["FULL"]][["FULLimputed 40 %"]][["S_Total_protein"]],
                         ncMICErf_MAR[["FULL"]][["FULLimputed 40 %"]][["S_Total_protein"]], 
                         missForest_MAR[["FULL"]][["FULLimputed 40 %"]][["S_Total_protein"]],
                         ncmissForest_MAR[["FULL"]][["FULLimputed 40 %"]][["S_Total_protein"]])

cn<- c("Original","ncCALIBERrfimpute","ncMICErf","ncmissForest", "MICErf", "missForest")
colnames(my.data.TotalProtein) <-cn
colnames(my.data.Albumin) <-cn

my.data.TotalProtein <-melt(my.data.TotalProtein)

my.data.Albumin<-melt(my.data.Albumin)

colnames(my.data.TotalProtein)[2] = "Imputation"
colnames(my.data.Albumin)[2] = "Imputation"

colnames(my.data.TotalProtein)[3] = "TotalProtein"
colnames(my.data.Albumin)[3] = "Albumin"

my.data<- cbind(my.data.TotalProtein, my.data.Albumin[,"Albumin"])
colnames(my.data)[4] = "Albumin"


# Fit polynomial regression line and add labels
formula <- y ~ x
plot <- ggplot(my.data, aes(x=Albumin, y=TotalProtein, color = Imputation)) +
  geom_point(alpha =0.4) +
  stat_smooth(aes(fill = Imputation, color = Imputation), method = "lm", formula = formula) +
  stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
    formula = formula
  ) +
  theme_bw() +
  scale_fill_manual(values = c("Original"="black",
                                      "ncCALIBERrfimpute" = "#F8766D",
                                      "ncMICErf"="#A3A500",
                                      "ncmissForest"="#00BF7D",
                                      "MICErf" = "#00B0F6",
                                      "missForest"="#E76BF3" ))+
  scale_color_manual(values = c("Original"="black",
                                      "ncCALIBERrfimpute" = "#F8766D",
                                      "ncMICErf"="#A3A500",
                                      "ncmissForest"="#00BF7D",
                                      "MICErf" = "#00B0F6",
                                      "missForest"="#E76BF3" ))+
  ggtitle("MAR Albumin and Total Protein")


ggpar(p, palette = "jco")

```

#bias scatter plots r2 and slope
```{r}
plot<-list()

for(i in 1:length(p)){
  my.data.Albumin <- cbind(SCdf$S_Albumin,
                         CALIBER_MAR[["FULL"]][[i]][["S_Albumin"]],
                         MICErf_MAR[["FULL"]][[i]][["S_Albumin"]], 
                         ncMICErf_MAR[["FULL"]][[i]][["S_Albumin"]], 
                         missForest_MAR[["FULL"]][[i]][["S_Albumin"]],
                         ncmissForest_MAR[["FULL"]][[i]][["S_Albumin"]])

my.data.TotalProtein <- cbind(SCdf$S_Total_protein,
                         CALIBER_MAR[["FULL"]][[i]][["S_Total_protein"]],
                         MICErf_MAR[["FULL"]][[i]][["S_Total_protein"]],
                         ncMICErf_MAR[["FULL"]][[i]][["S_Total_protein"]], 
                         missForest_MAR[["FULL"]][[i]][["S_Total_protein"]],
                         ncmissForest_MAR[["FULL"]][[i]][["S_Total_protein"]])

cn<- c("Original","ncCALIBERrfimpute","ncMICErf","ncmissForest", "MICErf", "missForest")
colnames(my.data.TotalProtein) <-cn
colnames(my.data.Albumin) <-cn

my.data.TotalProtein <-melt(my.data.TotalProtein)

my.data.Albumin<-melt(my.data.Albumin)

colnames(my.data.TotalProtein)[2] = "Imputation"
colnames(my.data.Albumin)[2] = "Imputation"

colnames(my.data.TotalProtein)[3] = "TotalProtein"
colnames(my.data.Albumin)[3] = "Albumin"

my.data<- cbind(my.data.TotalProtein, my.data.Albumin[,"Albumin"])
colnames(my.data)[4] = "Albumin"


# Fit polynomial regression line and add labels
formula <- y ~ x
plot [[i]]<- ggplot(my.data, aes(x=Albumin, y=TotalProtein, color = Imputation)) +
  geom_point(alpha =0.4) +
  stat_smooth(aes(fill = Imputation, color = Imputation), method = "lm", formula = formula) +
  stat_regline_equation(
    aes(label =  paste(..eq.label.., ..adj.rr.label.., sep = "~~~~")),
    formula = formula
  ) +
  theme_bw() +
  scale_fill_manual(values = c("Original"="black",
                                      "ncCALIBERrfimpute" = "#F8766D",
                                      "ncMICErf"="#A3A500",
                                      "ncmissForest"="#00BF7D",
                                      "MICErf" = "#00B0F6",
                                      "missForest"="#E76BF3" ))+
  scale_color_manual(values = c("Original"="black",
                                      "ncCALIBERrfimpute" = "#F8766D",
                                      "ncMICErf"="#A3A500",
                                      "ncmissForest"="#00BF7D",
                                      "MICErf" = "#00B0F6",
                                      "missForest"="#E76BF3" ))+
  ggtitle(paste("MAR Albumin and Total Protein ",p[,i] *100,"% Missing",sep=""))
}

plot[[5]]
ggarrange(plots = list(plot[[1]], plot[[2]], plot[[3]], plot[[4]]),ncol = 1, common.legend=TRUE)

```

```{r}

# 1. generating particles structure ------------------------------------------------

gen_par_st = function(cand_var, N_particles = 10, value = NULL){
  
  particles = data.frame(matrix(nrow = N_particles, ncol = length(cand_var)))
  rownames(particles) = paste0("particle", seq(1:N_particles))
  colnames(particles) = cand_var
  if(!is.null(value)){
    particles[] = value
  }
  return(particles)
}

# 2. generating first particle ------------------------------------------------

gen_first_par = function(particles){
  for (i in 1:nrow(particles)){
    particles[i,] = sample(c(0,1), replace = TRUE, size = ncol(particles))
    while(sum(particles[i,]) < 1){
      particles[i,] = sample(c(0,1), replace = TRUE, size = ncol(particles))
    }
  }
  return(particles)
}


# 3. fitness_eval_CART -------------------------------------------

fitness_eval_CART = function(X, y, particles, Ncores){
  
  fitness_score = c()
  # trainControl Setting
  if(is.factor(y)){
    if(length(levels(y)) == 2){
      fitControl = trainControl(method = "cv",
                                number = 5,
                                summaryFunction = twoClassSummary,
                                classProbs = TRUE)
      metric = "ROC"
    } else {
      fitControl = trainControl(method = "cv",
                                number = 5,
                                summaryFunction = multiClassSummary,
                                classProbs = TRUE)
      metric = "AUC"}
  } else {
    fitControl = trainControl(method = "cv",
                              number = 5)
    metric = "RMSE"
  }
  
  Cores_fit = Ncores
  cl_fit = makeCluster(Cores_fit)
  doParallel::registerDoParallel(cl_fit)
  
  fitness_score = foreach(p = 1:nrow(particles), .packages =c("rpart", "caret"),
                          .verbose = FALSE) %dopar% {
                            
                            particle_p = colnames(X)[which(particles[p,] == 1)]
                            X_ = X[particle_p]
                            
                            # fitting model
                            fit_rf = train(x = X_,
                                           y = y,
                                           method = "rpart",
                                           trControl = fitControl,
                                           metric = metric
                            )
                            
                            score = mean(unlist(fit_rf$results[metric]))
                            if(metric == "RMSE"){
                              score = -score
                            }
                            return(score)
                          }
  # stopCluster(cl_fit)
  fitness_score = unlist(fitness_score)
  return(fitness_score)
}


# 4. update p_best -----------------------------------------------------------

update_p_best = function(old_pop, new_pop){
  
  p_best = old_pop
  for(i in 1:nrow(old_pop)){
    if(new_pop$fitness[i] > old_pop$fitness[i]){
      p_best[i,] = new_pop[i,]
    }
  }
  return(p_best)
}


# 5. update g_best -----------------------------------------------------------

update_g_best = function(old_pop, new_pop){
  
  g_best = old_pop[which.max(old_pop$fitness),]
  if(max(new_pop$fitness) > max(old_pop$fitness)){
    g_best = new_pop[which.max(new_pop$fitness),]
  }
  
  g_id = g_best
  g_id = g_id[rep(seq_len(nrow(g_id)), nrow(old_pop)), ] ; row.names(g_id) = NULL
  return(g_id)
}


# 6. calculate new velocity --------------------------------------------------

calculate_new_velocity = function(w, v_old, c1, c2, p_id, g_id, x_id){
  
  # set r1 and r2
  r1 = runif(1)
  r2 = runif(1)
  
  # remove fitness column
  p_id = p_id[colnames(x_id)]
  g_id = g_id[colnames(x_id)]
  
  # pb_x and gb_x
  pb_x = p_id - x_id
  gb_x = g_id - x_id
  
  # calculate new velocity
  v_new = w*v_old + c1*r1*(pb_x) + c2*r2*(gb_x)
  return(v_new)
}


# 7. get new particles -------------------------------------------------------

get_new_par = function(new_position){
  
  new_particles = lapply(list(new_position), function(mydata_df){
    rand = runif(1, 0.1, 1)
    mydata_df %>% mutate_all(function(x) ifelse(x > rand, 1, 0))})
  new_particles = new_particles[[1]]
  
  rownames(new_particles) = paste0("particle", seq(1:nrow(new_particles)))
  return(new_particles)
}


# 8. BPSO algorithm -------------------------------------------

BPSO = function(X, y, N_particles, Iteration, w, c1, c2, var_len, verbose = NULL, Ncores){
  
  if(is.null(N_particles)){N_particles = 10}
  if(is.null(Iteration)){Iteration = 3}
  if(is.null(w)){w = 0.3}
  if(is.null(c1)){c1 = 0.3}
  if(is.null(c2)){c2 = 0.6}
  if(is.null(var_len)){var_len = 20}
  if(is.null(verbose)){verbose = FALSE}
  
  filter_var = which(sapply(X, function(x){(length(unique(x)) > 1)}))
  filter_var_names = colnames(X)[filter_var]
  Cores_fit = Ncores
  cl_fit = makeCluster(Cores_fit)
  doParallel::registerDoParallel(cl_fit)
  fit_aic = foreach(i = filter_var, .packages =c("rpart", "caret"),
                    .export = c("fit_simple_model"),
                    .verbose = FALSE) %dopar% {
                      x = X[,i]
                      aic = fit_simple_model(X = x, y = y)
                      return(aic)
                    }
  stopCluster(cl_fit)
  fit_aic = unlist(fit_aic)
  
  # first twenty variables with low AIC  
  if(length(fit_aic) >= var_len){
    cand_var = filter_var_names[order(fit_aic)[1:var_len]] 
  } else {
    cand_var = filter_var_names[order(fit_aic)]
  }
  
  v_old = gen_par_st(cand_var = cand_var, N_particles = 10, value = 0.3)
  par_st = gen_par_st(cand_var = cand_var, N_particles = 10)
  
  for(Iter in 1:Iteration){
    
    if(Iter == 1){
      # generating particles and evaluate fitness
      particles = gen_first_par(particles = par_st)
    }
    if(verbose){cat(paste0("Iteration: ", Iter))}
    
    fitness = fitness_eval_CART(X = X, y = y, particles = particles, Ncores = Ncores)
    pop = cbind(particles, fitness)
    if(verbose){cat(paste0("Fitness evaluated in Iteration ", Iter))}
    
    if(Iter == 1){
      # update p_best value and position
      p_best = update_p_best(old_pop = pop, new_pop = pop)
      
      # update g_best value and position
      g_best = update_g_best(old_pop = pop, new_pop = pop)
    } else {
      # update p_best value and position
      p_best = update_p_best(old_pop = pop_Old, new_pop = pop)
      
      # update g_best value and position
      g_best = update_g_best(old_pop = pop_Old, new_pop = pop)
    }
    
    # calculate new velocity
    v_new = calculate_new_velocity(w = w, v_old = v_old, c1 = c1, c2 = c2, p_id = p_best,
                                   g_id = g_best, x_id = particles)
    
    # get new position
    new_pos = sigmoid(v_new) # library("e1071")
    particles = get_new_par(new_position = new_pos)
    while(any(apply(particles, 1, sum) < 1)){
      if(verbose){cat("getting new position")}
      particles = get_new_par(new_position = new_pos)
    }
    pop_Old = pop
  } # Iteration
  
  final_result = g_best[1,]
  return(final_result)
}

# 9. imputation ----------------------------------------------------------


imputation = function(mydata_true, 
                      mydata_ref, 
                      mydata_impu, 
                      var_cat, 
                      var_con, 
                      target_var_miss = NULL, 
                      Ncores, 
                      mt = "mf", 
                      mar = NULL, 
                      ntree = 100){
  
  
  # imputation_bpso ---------------------------------------------------------
  if(mt == "bp"){
    
    # BPSO + missforest
    
    if(!is.null(mydata_true)){mydata_true = mydata_true[colnames(mydata_ref)]}
    mydata_impu = mydata_impu[colnames(mydata_ref)]
    
    mydata_ref_org = mydata_ref
    mydata_impu_org = mydata_impu
    
    impu_var_idx = which(colnames(mydata_ref) %in% c(var_cat, var_con))
    if(!is.null(target_var_miss)){
      idx_target_var = which(colnames(mydata_ref) %in% target_var_miss)
      impu_var_idx = intersect(impu_var_idx, idx_target_var)
    }
    target_var = colnames(mydata_ref)[impu_var_idx]
    
    # numeric y
    num_y = intersect(which(sapply(mydata_ref, function(x){is.numeric(x)})), impu_var_idx)
    # categorical y(binary)
    binary_y = intersect(which(sapply(mydata_ref, function(x){is.factor(x) & length(levels(x)) == 2})), impu_var_idx)
    # categorical y(multiclass)
    multi_y = intersect(which(sapply(mydata_ref, function(x){is.factor(x) & length(levels(x)) > 2})), impu_var_idx)
    
    sprintf("imputation_start at: %s", Sys.time())
   # pb <- progress_bar$new(total = length(impu_var_idx))
    
    for(i in impu_var_idx){
      #pb$tick()
      X = mydata_ref[, -i]; y = mydata_ref[, i]
      if(i %in% c(binary_y, multi_y)) {y = paste0("class",y); y = as.factor(y)}
      
      feature = tryCatch(try(BPSO(X = X, y = y,
                                  N_particles = 20, Iteration = 3, w = 0.3, c1 = 0.3, c2 = 0.6, var_len = floor(sqrt(ncol(X))),
                                  verbose = FALSE, Ncores = Ncores)))
      if(class(feature) != "try-error"){
        var_sel_temp = setdiff(colnames(feature)[which(feature[1,] == 1)], "fitness") # select variable
        
        x_mis = cbind(mydata_impu[colnames(mydata_ref)[i]], mydata_ref[var_sel_temp])
        if(getDoParWorkers() == 1 | getDoParWorkers() < Ncores){
          if(Ncores > length(var_sel_temp)){
            Ncores = length(var_sel_temp)
          }
        } else if(getDoParWorkers() >= length(var_sel_temp)) {
          Ncores = length(var_sel_temp)
        }
        cl_inner = makeCluster(Ncores)
        doParallel::registerDoParallel(cl_inner)
        mf_rst = tryCatch(try(missForest::missForest(xmis = x_mis, verbose = TRUE,
                                                     parallelize = "variables",
                                                     maxiter = 2, ntree = ntree,
                                                     replace = FALSE)))
        if(class(mf_rst) == 'try-error'){
          sprintf("Error in missforest : %s ", mf_rst[[1]])
        } else {
          x_impu = mf_rst$ximp[colnames(mydata_ref)[i]]
          if(colnames(x_impu) == colnames(mydata_ref)[i]){
            mydata_ref[colnames(x_impu)] = x_impu
            mydata_impu[colnames(x_impu)] = x_impu
          }
        }
      } else { # class(feature) != "try-error"
        sprintf("Error in BPSO : %s ", feature[[1]])
      }  ; rm(X, y, feature, var_sel_temp, x_mis, mf_rst, x_impu)
      
    } # for loop 
    
    sprintf("imputation_completed at: %s", Sys.time())
    
    xtrue = mydata_true ; xref = mydata_ref_org ; xmis = mydata_impu_org
    x_impu_df = mydata_impu[target_var]
    xtrue = xtrue[target_var] ; xref = xref[target_var] ; xmis = xmis[target_var]
    result = list(ximp = x_impu_df, xtrue = xtrue, xref = xref, xmis = xmis,
                  target = target_var, numvar = colnames(mydata_ref)[num_y], bivar = colnames(mydata_ref)[binary_y], multivar = colnames(mydata_ref)[multi_y]
                  # var_selected
    )
    
  } else if(mt == "mf") {
    # browser()
    # imputation_missforest ---------------------------------------------------
    
    impu_var_idx = which(colnames(mydata_ref) %in% c(var_cat, var_con))
    if(!is.null(target_var_miss)){
      idx_target_var = which(colnames(mydata_ref) %in% target_var_miss)
      impu_var_idx = intersect(impu_var_idx, idx_target_var)
    }
    target_var = colnames(mydata_ref)[impu_var_idx]
    mydata_impu[setdiff(colnames(mydata_ref), target_var)] = mydata_ref[setdiff(colnames(mydata_ref), target_var)]
    
    # numeric y
    num_y = intersect(which(sapply(mydata_ref, function(x){is.numeric(x)})), impu_var_idx)
    # categorical y(binary)
    binary_y = intersect(which(sapply(mydata_ref, function(x){is.factor(x) & length(levels(x)) == 2})), impu_var_idx)
    # categorical y(multiclass)
    multi_y = intersect(which(sapply(mydata_ref, function(x){is.factor(x) & length(levels(x)) > 2})), impu_var_idx)
    
    cl_inner = makeCluster(Ncores)
    doParallel::registerDoParallel(cl_inner)
    sprintf("imputation_start at: %s", Sys.time())
    mf_rst = tryCatch(try(missForest::missForest(xmis = mydata_impu, verbose = TRUE,
                                                 parallelize = "no", maxiter = 5,
                                                 ntree = ntree,
                                                 replace = FALSE)))
    
    sprintf("imputation_completed at: %s", Sys.time())
    
    if(class(mf_rst) == 'try-error'){
      sprintf(
        "Error in missforest : %s ",
        mf_rst[[1]])
    } else {
      mydata_ref[target_var] = ximp = mf_rst$ximp
      result = mydata_ref
    }
  } 
  
  stopCluster(cl_inner)
  
  if(exists("result")){
    impu_result = result
    return(impu_result)
  }
  print(mydata_true)
}

## example 
library(car)
data("iris")
iris.mis <- prodNA(iris, noNA = 0.1)
# mydata_true=NULL
# mydata_ref=mydata_impu=iris.mis
# var_cat (categorical variable)="Species"
# var_con (continuous variable)= c("Sepal.Length", "Sepal.Width","Petal.Length", "Petal.Width")
# mt (method)="mt"
library(parallel)

#make predictors factors (can also be numeric, just not characters, max of 53 categories per variable allowed)
  x<-SCdf
  columns_to_remove <- c("Toxin", "Study_id", "S_Comments")
 x <- x[, !names(x) %in% columns_to_remove]
  #x<- cbind(x, SCdf[,12:22])
  y<- MNAR[["missing 40 %"]]
y <-y[, !names(y) %in% columns_to_remove]
 x[sapply(x, is.character)] <- lapply(x[sapply(x, is.character)], as.factor)
#x[sapply(x, is.factor)] <- lapply(x[sapply(x, is.factor)], as.numeric)

 y[sapply(y, is.character)] <- lapply(y[sapply(y, is.character)], as.factor)
 #y[sapply(y, is.factor)] <- lapply(y[sapply(y, is.factor)], as.numeric)

missForest::missForest(
                        xmis = mydata_impu,
                        verbose = TRUE,
                        parallelize = "no",
                        maxiter = 5,
                        ntree = ntree,
                        replace = FALSE
                      )

           irisimp<- imputation(mydata_true = x, 
                      mydata_ref = x, 
                      mydata_impu = y, 
                      var_cat = c("Company","Target","Key" , "Animal_no.", "Timepoint", "Sacrifice_subgroup", "doseFlag") , 
                      var_con = c("S_Creatinine", "S_Urea_nitrogen", "S_ALT", "S_AST", "S_Glucose", "S_Sodium", "S_Potassium", "S_Calcium", "S_Phosphorus", "S_Albumin", "S_Total_protein"), 
                      target_var_miss = c("S_Creatinine", "S_Urea_nitrogen", "S_ALT", "S_AST", "S_Glucose", "S_Sodium", "S_Potassium", "S_Calcium", "S_Phosphorus", "S_Albumin", "S_Total_protein"), 
                      Ncores = NULL, 
                      mt = "bp", 
                      mar = NULL, 
                      ntree = 10)

```
